var j=Object.defineProperty;var J=(r,n,s)=>n in r?j(r,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[n]=s;var x=(r,n,s)=>J(r,typeof n!="symbol"?n+"":n,s);import{d as F,c as M,o as D,W as S,b5 as W,az as I,b as i,w as a,u as o,e as g,_ as E,ao as V,p as T,aw as q,bg as Z,at as K,bh as Q,A as O,Z as X,af as Y,a1 as tt,t as b,as as P,B as $,a3 as L,bi as et}from"./index-B5qY8s78.js";import{R as ot}from"./ResponsiveDirectionLayout-DH5AVpdY.js";import{N as _}from"./InputGroupLabel-Hl8FjA1l.js";import{N as U}from"./Select-CHP7QsKV.js";import{N as k}from"./InputGroup-C4kdjZvW.js";import{N as nt}from"./InputNumber-BJbmMZm4.js";import{N as it}from"./Slider-ClQtX1OD.js";import{N as at}from"./ButtonGroup-CrSjHNte.js";import{N as st,a as lt,b as rt}from"./Upload-CGK7A2yt.js";import{A as ut}from"./Add-a7ZTVCHA.js";import{C as dt}from"./CloudDownloadOutline-WL69qNLw.js";import{N as A}from"./text-DkcpT20C.js";import"./Suffix-5gkYIGRw.js";import"./attribute-Cz32yFEB.js";import"./Empty-CNxvJzqS.js";import"./use-locale-DIILPpkH.js";import"./Input-B4oUZfUz.js";import"./Progress-BQzVHWoO.js";import"./Image-CS3nnoeG.js";import"./_createCompounder-D2vDpZKt.js";const ft={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},pt=S("path",{d:"M112 111v290c0 17.44 17 28.52 31 20.16l247.9-148.37c12.12-7.25 12.12-26.33 0-33.58L143 90.84c-14-8.36-31 2.72-31 20.16z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),ct=[pt],mt=F({name:"PlayOutline",render:function(n,s){return D(),M("svg",ft,ct)}}),ht={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},vt=S("rect",{x:"96",y:"96",width:"320",height:"320",rx:"24",ry:"24",fill:"none",stroke:"currentColor","stroke-linejoin":"round","stroke-width":"32"},null,-1),gt=[vt],yt=F({name:"StopOutline",render:function(n,s){return D(),M("svg",ht,gt)}});var B=(r=>(r.LE="le",r.BE="be",r.LittleEndian="le",r.BigEndian="be",r))(B||{});class Ct{constructor(){x(this,"audioContext");x(this,"isPlaying",!1);x(this,"source");x(this,"audioBuffer");x(this,"gainNode");x(this,"currentVolume",1);x(this,"startTime",0);x(this,"duration",0);x(this,"playStartTime",0);x(this,"offsetTime",0);x(this,"onPlayCompleted");x(this,"playProgressCallback")}get totalDuration(){return this.audioBuffer?this.audioBuffer.duration:0}init(){if(!this.audioContext){const n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.currentVolume}}setVolume(n){if(!this.gainNode){console.warn("增益节点未初始化，请先调用 init() 或 playPCM()");return}const s=Math.max(0,Math.min(1,n));this.currentVolume=s,this.gainNode.gain.value=s}async initPCM(n,s={}){if(this.init(),!this.audioContext){console.error("音频上下文初始化失败");return}const{sampleRate:t=16e3,channelCount:e=1,bitDepth:m=16,startTime:c=0,duration:h=0,endianness:d="le",volume:l=1}=s;this.startTime=c,this.duration=h,this.setVolume(l),this.stop();try{const u=this.convertPCMToFloat32(n,m,d);this.audioBuffer=this.audioContext.createBuffer(e,u.length/e,t);for(let f=0;f<e;f++){const w=this.audioBuffer.getChannelData(f);for(let v=0;v<w.length;v++)w[v]=u[v*e+f]}}catch(u){console.error("播放 PCM 失败：",u)}}async playPCM(n,s){if(n)this.initPCM(n,s);else if(!this.audioBuffer){console.error("请传入 PCM 音频数据");return}this.audioContext&&(this.offsetTime=0,this.play())}playFromPosition(n=0,s=0){if(!this.audioBuffer||!this.audioContext){console.error("请先加载 PCM 数据");return}this.isPlaying&&this.stop();const t=this.audioBuffer.duration,e=Math.max(0,Math.min(n,t)),m=s>0?Math.min(s,t-e):void 0;this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.gainNode),this.source.start(0,e,m),this.isPlaying=!0,this.playStartTime=this.audioContext.currentTime,this.source.onended=()=>{var c,h;this.isPlaying=!1,this.offsetTime+=(((c=this.audioContext)==null?void 0:c.currentTime)||0)-this.playStartTime,(h=this.onPlayCompleted)==null||h.call(this)}}convertPCMToFloat32(n,s,t="le"){const e=new DataView(n),m=s/8,c=t==="le",h=Math.floor(n.byteLength/m),d=new Float32Array(h);for(let l=0;l<h;l++){const u=l*m;switch(s){case 8:d[l]=(e.getUint8(u)-128)/128;break;case 16:d[l]=e.getInt16(u,c)/32768;break;case 24:let f;c?f=e.getUint8(u)|e.getUint8(u+1)<<8|e.getUint8(u+2)<<16:f=e.getUint8(u)<<16|e.getUint8(u+1)<<8|e.getUint8(u+2),f&8388608&&(f|=4278190080),d[l]=f/8388608;break;case 32:d[l]=e.getInt32(u,c)/2147483648;break}}return d}updatePlayProgress(){const{isPlaying:n,audioContext:s,audioBuffer:t,offsetTime:e,playStartTime:m,playProgressCallback:c}=this;if(!n||!s||!t||!c)return;const h=e+(s.currentTime-m),d=h/t.duration*100,l=h.toFixed(2),u=t.duration.toFixed(2),f=d.toFixed(1);console.log(`播放进度：${l}秒 / ${u}秒 (${f}%)`),c(l,u,f),requestAnimationFrame(()=>this.updatePlayProgress())}play(){if(!this.isPlaying){const{startTime:n,duration:s,offsetTime:t}=this;t+n>=this.totalDuration&&(this.offsetTime=0),this.playFromPosition(n+this.offsetTime,s),this.updatePlayProgress()}}stop(){if(this.source){try{this.source.stop()}catch{}this.source.disconnect(),this.source=void 0}}clear(){this.stop(),this.isPlaying=!1,this.audioBuffer=void 0}}const xt={class:"options-panel"},bt=F({__name:"options",props:{options:{required:!0},optionsModifiers:{}},emits:["update:options"],setup(r){const n=W(r,"options");return(s,t)=>(D(),M("div",xt,[I(s.$slots,"prefix",{},void 0,!0),i(o(k),null,{default:a(()=>[i(o(_),null,{default:a(()=>[...t[5]||(t[5]=[g("采样率",-1)])]),_:1}),i(o(U),{value:n.value.sampleRate,"onUpdate:value":t[0]||(t[0]=e=>n.value.sampleRate=e),options:[8e3,16e3,22050,24e3,44100,48e3,96e3,192e3].map(e=>({label:String(e),value:e}))},null,8,["value","options"]),i(o(_),null,{default:a(()=>[...t[6]||(t[6]=[g("Hz",-1)])]),_:1})]),_:1}),i(o(k),null,{default:a(()=>[i(o(_),null,{default:a(()=>[...t[7]||(t[7]=[g("位深",-1)])]),_:1}),i(o(U),{value:n.value.bitDepth,"onUpdate:value":t[1]||(t[1]=e=>n.value.bitDepth=e),options:[8,16,24,32].map(e=>({label:String(e),value:e}))},null,8,["value","options"]),i(o(_),null,{default:a(()=>[...t[8]||(t[8]=[g("bit",-1)])]),_:1})]),_:1}),i(o(k),null,{default:a(()=>[i(o(_),null,{default:a(()=>[...t[9]||(t[9]=[g("声道数",-1)])]),_:1}),i(o(nt),{value:n.value.channelCount,"onUpdate:value":t[2]||(t[2]=e=>n.value.channelCount=e),min:1,precision:0},null,8,["value"]),i(o(_),null,{default:a(()=>[...t[10]||(t[10]=[g("ch",-1)])]),_:1})]),_:1}),i(o(k),null,{default:a(()=>[i(o(_),null,{default:a(()=>[...t[11]||(t[11]=[g("字节序",-1)])]),_:1}),i(o(U),{value:n.value.endianness,"onUpdate:value":t[3]||(t[3]=e=>n.value.endianness=e),options:[{label:"小端序",value:o(B).LE},{label:"大端序",value:o(B).BE}]},null,8,["value","options"])]),_:1}),i(o(k),null,{default:a(()=>[i(o(_),null,{default:a(()=>[...t[12]||(t[12]=[g("音量",-1)])]),_:1}),i(o(it),{value:n.value.volume,"onUpdate:value":t[4]||(t[4]=e=>n.value.volume=e),min:0,max:1,step:.01},null,8,["value"])]),_:1}),I(s.$slots,"suffix",{},void 0,!0)]))}}),_t=E(bt,[["__scopeId","data-v-81cd2557"]]),wt=["id"],Pt=F({__name:"HandleFileDrag",emits:["drop-callback"],setup(r,{emit:n}){const s=n,t=V("handle-file-drag-"),e=T(!1);function m(l){if(l.preventDefault(),l.stopPropagation(),!l.dataTransfer){e.value=!1;return}const u=l.dataTransfer.types;e.value=u.includes("Files")}function c(l){m(l)}function h(l){l.target.id==t&&(e.value=!1)}function d(l){var f;l.preventDefault(),l.stopPropagation(),e.value=!1;const u=(f=l.dataTransfer)==null?void 0:f.files;s("drop-callback",Array.from(u||[]))}return(l,u)=>{var f,w;return D(),M("div",{id:o(t),class:K(["handle-file-drag",e.value&&"file-drop-hint"]),style:q({"--color":((w=(f=o(Z).theme)==null?void 0:f.common)==null?void 0:w.successColor)||"#63e2b7"}),"drag-tip":"请将音频文件拖拽至此",onDragenter:m,onDragover:c,onDragleave:h,onDrop:d},[I(l.$slots,"default",{},void 0,!0)],46,wt)}}}),Tt=E(Pt,[["__scopeId","data-v-bf2639f9"]]),z=r=>r.toString().padStart(2,"0");function R(r){return`${z(Math.floor(r/60))}:${z((r%60).toFixed(0))}`}function Dt(r,n){const{options:s,name:t}=r,e=t.lastIndexOf("."),m=e>0?t.substring(e+1):"异常！",c=R(s.startTime||0);return{...s,name:t,currentTime:c,totalDuration:R(n),size:Q(r.file.size),type:m.toLocaleUpperCase()}}const Nt={key:0,class:"audio-player-container"},kt=["id"],Bt={class:"time-container"},H=".mp3,.pcm,.wav",Ft=F({__name:"index",setup(r){const n=V("audio-player-"),s=V("file-list-"),t=T(!1),e=T({sampleRate:16e3,bitDepth:16,channelCount:1,startTime:0,duration:0,endianness:B.LE,volume:.5}),m=new Ct;m.onPlayCompleted=()=>{t.value=!1};const c=T(void 0),h=T([]),d=T();O([e,c],async([v,p])=>{if(typeof p=="number"){const y=h.value[p],C=await y.file.arrayBuffer();m.initPCM(C,v),d.value=Dt(y,m.totalDuration)}},{deep:!0}),O(t,v=>{v?m.play():m.stop()});function l(v){const p=C=>H.split(",").some(N=>C.endsWith(N)),y=v.filter(C=>p(C.name));y.length>0?y.forEach(C=>{h.value.push({id:String(C.lastModified),name:C.name,status:"pending",file:C,options:{}})}):window.$message.warning("请拖拽音频文件")}function u(){et.get("./multimedia/Jay Chou.pcm",{responseType:"blob"}).then(v=>{const p=new File([v.data],"Jay Chou.pcm");h.value.push({id:String(p.lastModified),name:p.name,status:"finished",file:p,options:{sampleRate:24e3,bitDepth:16,channelCount:2,endianness:B.LE}}),f(h.value.length-1)})}function f(v){c.value=v,Object.assign(e.value,h.value[v].options),setTimeout(()=>{document.querySelectorAll(`#${s} .n-upload-file`).forEach((y,C)=>{y.classList.remove("active"),C==v&&y.classList.add("active")})},100)}function w(v){const p=v.target.closest(".n-button"),y=v.target.closest(".n-upload-file");if(!y)return;const C=document.querySelectorAll(`#${s} .n-upload-file`),N=Array.from(C).findIndex(G=>G===y);if(p){N==c.value&&(c.value=void 0,t.value=!1,m.clear());return}N!=-1&&f(N)}return(v,p)=>(D(),X(Tt,{onDropCallback:l},{default:a(()=>[i(ot,{"default-size":.35,min:0},{left:a(()=>[i(_t,{options:e.value,"onUpdate:options":p[2]||(p[2]=y=>e.value=y)},{prefix:a(()=>[i(o(st),{"file-list":h.value,"onUpdate:fileList":p[0]||(p[0]=y=>h.value=y),abstract:"",accept:H,multiple:""},{default:a(()=>[i(o(at),null,{default:a(()=>[i(o(lt),{abstract:""},{default:a(({handleClick:y})=>[i(o($),{type:"info",onClick:y},{icon:a(()=>[i(o(L),{component:o(ut)},null,8,["component"])]),default:a(()=>[p[3]||(p[3]=g(" 选择或拖入文件 ",-1))]),_:1},8,["onClick"])]),_:1}),i(o($),{type:"info",ghost:"",onClick:u},{icon:a(()=>[i(o(L),{component:o(dt)},null,8,["component"])]),default:a(()=>[p[4]||(p[4]=g(" 加载样例 ",-1))]),_:1})]),_:1}),i(o(rt),{id:o(s),onClick:w},null,8,["id"])]),_:1},8,["file-list"])]),suffix:a(()=>[i(o($),{disabled:typeof c.value!="number",type:t.value?"error":"success",ghost:"",onClick:p[1]||(p[1]=y=>t.value=!t.value)},{icon:a(()=>[i(o(L),{component:t.value?o(yt):o(mt)},null,8,["component"])]),default:a(()=>[g(" "+b(t.value?"暂停":"播放"),1)]),_:1},8,["disabled","type"])]),_:1},8,["options"])]),right:a(()=>[d.value?(D(),M("div",Nt,[i(o(tt),null,{default:a(()=>[i(o(A),null,{default:a(()=>[g(b(d.value.name),1)]),_:1}),i(o(P),{type:"info"},{default:a(()=>[g(b(d.value.type),1)]),_:1}),i(o(P),{color:{color:"#8a2be21a",textColor:"#9339E7FF",borderColor:"#9339E7FF"}},{default:a(()=>[g(b(d.value.size),1)]),_:1}),i(o(P),{type:"success"},{default:a(()=>[g(b(d.value.totalDuration),1)]),_:1}),i(o(P),{type:"warning"},{default:a(()=>[g(b(d.value.sampleRate)+"Hz ",1)]),_:1}),i(o(P),null,{default:a(()=>[g(b(d.value.channelCount)+"ch ",1)]),_:1}),i(o(P),null,{default:a(()=>[g(b(d.value.bitDepth)+"bit ",1)]),_:1})]),_:1}),S("canvas",{id:o(n),style:q({"--channel-count":e.value.channelCount})},null,12,kt),S("div",Bt,[i(o(A),null,{default:a(()=>[g(b(d.value.currentTime),1)]),_:1}),i(o(A),null,{default:a(()=>[g(b(d.value.totalDuration),1)]),_:1})])])):Y("",!0)]),_:1})]),_:1}))}}),Xt=E(Ft,[["__scopeId","data-v-4fa8a425"]]);export{Xt as default};
