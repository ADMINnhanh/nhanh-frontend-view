var N=Object.defineProperty;var B=(p,e,t)=>e in p?N(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var l=(p,e,t)=>B(p,typeof e!="symbol"?e+"":e,t);import{bF as L,cB as T,cC as G,cD as X,cE as Y,cF as _,cG as E}from"./index-CL_Q9027.js";class W{constructor(e){l(this,"canvas");l(this,"axis_canvas",document.createElement("canvas"));l(this,"ctx",this.axis_canvas.getContext("2d"));l(this,"isReload",!1);l(this,"show",{all:!0,grid:{main:!0,secondary:!0},axis:!0,axisText:!0});this.canvas=e,this.initAxisCanvas()}initAxisCanvas(){var s,i;const{canvas:e,axis_canvas:t}=this;e&&(t.width=((s=e.rect)==null?void 0:s.value.width)||0,t.height=((i=e.rect)==null?void 0:i.value.height)||0)}toggleAxis(e){const t=(()=>{if(typeof e=="object"){const{all:s=!0,grid:i={main:!0,secondary:!0},axis:n=!0,axisText:a=!0}=e;return Object.assign({main:!0,secondary:!0},i),{all:s,grid:i,axis:n,axisText:a}}return typeof e=="boolean"?{all:!0,grid:{main:e,secondary:e},axis:e,axisText:e}:!this.show.all})();typeof t=="boolean"?this.show.all=t:this.show=t,this.isReload=!0}drawAxisAndGrid(){if(!(!this.canvas||!this.show.all))return(this.canvas.isRecalculate||this.isReload||this.canvas.isThemeUpdated)&&(this.isReload=!1,this.initAxisCanvas(),(this.show.grid.main||this.show.grid.secondary)&&this.drawGrid(),this.show.axis&&this.drawAxis(),this.show.axisText&&this.drawAxisText()),this.axis_canvas}color(){const{theme:e,style:t}=this.canvas;return(t[e]||t.light).grid}drawGrid(){const{canvas:e,ctx:t}=this,{rect:s,center:i,axisConfig:n}=e,{width:a,height:o}=s.value,r=this.color(),h=n.size,c=h/5;t.lineWidth=1;const d=(y,v)=>{const f=i.x%y>0?i.x%y:y+i.x%y;t.strokeStyle=v,t.beginPath();for(let m=0;m*y+f<=a;m++)t.moveTo(m*y+f,0),t.lineTo(m*y+f,o);t.stroke()},u=(y,v)=>{const f=i.y%y>0?i.y%y:y+i.y%y;t.strokeStyle=v,t.beginPath();for(let m=0;m*y+f<=o;m++)t.moveTo(0,m*y+f),t.lineTo(a,m*y+f);t.stroke()};this.show.grid.secondary&&(d(c,r.innerGrid),u(c,r.innerGrid)),this.show.grid.main&&(d(h,r.grid),u(h,r.grid))}drawAxis(){const{canvas:e,ctx:t}=this,{rect:s,center:i}=e,{width:n,height:a}=s.value,o=this.color();t.lineWidth=2,t.strokeStyle=o.axis;const r=()=>{i.y>=0&&i.y<=a&&(t.beginPath(),t.moveTo(0,i.y),t.lineTo(n,i.y),t.stroke())},h=()=>{i.x>=0&&i.x<=n&&(t.beginPath(),t.moveTo(i.x,0),t.lineTo(i.x,a),t.stroke())};r(),h()}drawText(e,t,s,i){const{canvas:n,ctx:a}=this,{theme:o}=n,r=this.canvas.style[o].text;a.font=`${r.bold?"bold":""} ${r.size}px ${r.family}`,a.strokeStyle=r.stroke,a.strokeText(e,t,s),a.fillStyle=r[i?"secondary":"color"],a.fillText(e,t,s)}drawAxisText(){const{canvas:e,ctx:t}=this,{rect:s,center:i,axisConfig:n,style:a,theme:o}=e,{width:r,height:h}=s.value,c=f=>Math.ceil(t.measureText(f).width),d=4,u=a[o].text.size;{const f=c("0"),m=i.x<d||i.x>r+f+d,P=i.y<-(d+u)||i.y>h+u+d;!m&&!P&&this.drawText("0",i.x-f-d,i.y+u+d)}const y=e.getGridCount(),v=n.size;{let f=i.y+u+d;f=Math.max(Math.min(f,h-d),d+u);const m=i.y>h||i.y<0;let P=i.x>0?i.x%v:i.x<0?v+i.x%v:0,g=e.getAxisValueByPoint((P-i.x)*n.x,0).xV;for(;P<=r;){const C=c(String(g));g!==0&&this.drawText(String(g),P-C/2,f,m),P+=v,g=e.preservePrecision(g+y*n.x)}}{const f=i.x>r||i.x<0;let m=i.y>0?i.y%v:i.y<0?v+i.y%v:0,P=e.getAxisValueByPoint(0,(m-i.y)*n.y).yV;for(;m<=h;){const g=c(String(P));let C=i.x-g-d;C=Math.max(Math.min(C,r-g-d),d),P!==0&&this.drawText(String(P),C,m+u/2,f),m+=v,P=e.preservePrecision(P+y*n.y)}}}}class M{constructor(e){l(this,"show",!0);l(this,"scales");l(this,"notifyReload");(e==null?void 0:e.show)!==void 0&&(this.show=e.show),e!=null&&e.scales&&(this.scales=e.scales)}setShow(e){var t;e!=this.show&&(this.show=e,(t=this.notifyReload)==null||t.call(this,!0))}setScales(e){var t;e!=this.scales&&(this.scales=e,this.show&&((t=this.notifyReload)==null||t.call(this)))}shouldRender(e,t){if(!this.show||e===void 0||t===0)return!1;if(this.scales){const s=Math.min(...this.scales),i=Math.max(...this.scales);return e>=s&&e<=i}return!0}}const j=["click","dblclick","hover","draggable"];class w{constructor(e){l(this,"show",new M);l(this,"style");l(this,"position");l(this,"value");l(this,"zIndex");l(this,"dynamicPosition");l(this,"name");l(this,"isInteractable",!0);l(this,"path");l(this,"extData");l(this,"eventListener",new Map);l(this,"isClick",!1);l(this,"clickTime",0);l(this,"isDblClick",!1);l(this,"isDown",!1);l(this,"isHover",!1);l(this,"draggable",!1);l(this,"mainCanvas");l(this,"notifyReload");this.mainCanvas=e.mainCanvas,e.notifyReload&&this.setNotifyReload(e.notifyReload),this.show.setShow(e.show??!0),this.style=e.style,this.zIndex=e.zIndex??0,this.position=e.position,this.dynamicPosition=e.dynamicPosition,this.value=e.value,this.name=e.name,this.draggable=e.draggable??!1,this.isInteractable=e.isInteractable??!0,j.forEach(t=>this.eventListener.set(t,new Set))}addEventListener(e,t){var s;(s=this.eventListener.get(e))==null||s.add(t)}removeEventListener(e,t){var s;(s=this.eventListener.get(e))==null||s.delete(t)}notifyClick(e,t,s){var i,n;e?(this.isDblClick=Date.now()-this.clickTime<300,this.clickTime=Date.now()):(this.isDblClick=!1,this.clickTime=0),this.isClick=e,this.isInteractable&&(this.isDblClick?(i=this.eventListener.get("dblclick"))==null||i.forEach(a=>a(!0)):this.isClick&&((n=this.eventListener.get("click"))==null||n.forEach(a=>a(!0))))}notifyDown(e,t,s){this.isDown=e}notifyHover(e,t,s){var i;this.isHover=e,this.isInteractable&&((i=this.eventListener.get("hover"))==null||i.forEach(n=>n(e)))}notifyDraggable(e,t){var s;if(this.mainCanvas){const{percentage:i,axisConfig:n}=this.mainCanvas,a=n.count/n.min/i,o={value:e*a*n.x,position:e/i*n.x,dynamicPosition:e*n.x},r={value:t*a*n.y,position:t/i*n.y,dynamicPosition:t*n.y};return{x:o,y:r}}this.isInteractable&&((s=this.eventListener.get("draggable"))==null||s.forEach(i=>i(!0)))}isPointInAnywhere(e,t){return this.isPointInPath(e,t)||this.isPointInStroke(e,t)}setMainCanvas(e){this.mainCanvas=e,e&&this.updateBaseData()}equalsMainCanvas(e){return this.mainCanvas===e}setNotifyReload(e){this.notifyReload=e?t=>{var s;(t||this.show.shouldRender((s=this.mainCanvas)==null?void 0:s.scale))&&e()}:void 0,this.show.notifyReload=this.notifyReload}setStyle(e){var t;this.style=e,this.dynamicPosition&&((t=this.notifyReload)==null||t.call(this))}setZIndex(e){var t;this.zIndex=e,this.dynamicPosition&&((t=this.notifyReload)==null||t.call(this))}setPosition(e){var s;this.position=e,this.value=void 0;const t=!!this.dynamicPosition;this.updateBaseData(),(this.dynamicPosition||t)&&((s=this.notifyReload)==null||s.call(this))}setValue(e){var s;this.value=e,this.position=void 0;const t=!!this.dynamicPosition;this.updateBaseData(),(this.dynamicPosition||t)&&((s=this.notifyReload)==null||s.call(this))}}l(w,"ctx",document.createElement("canvas").getContext("2d"));class x{static PreservePrecision(e,t){const s=Number(e);return isNaN(s)?0:Number.isInteger(s)?s:Number(s.toFixed(t))}static LngLatToPlane(e,t){const s=Math.max(Math.min(e,180),-180),i=Math.max(Math.min(t,this.MAX_LAT),-this.MAX_LAT),n=s*this.PI_OVER_180*this.EARTH_RADIUS,a=i*this.PI_OVER_180,o=Math.log(Math.tan(Math.PI/4+a/2))*this.EARTH_RADIUS;return[n,o]}static PlaneToLngLat(e,t){const s=e/this.EARTH_RADIUS/this.PI_OVER_180,i=(2*Math.atan(Math.exp(t/this.EARTH_RADIUS))-this.HALF_PI)/this.PI_OVER_180;return[s,i]}static PointToLineDistance(e,t,s){const[i,n]=e,[a,o]=t,[r,h]=s,c=(r-a)**2+(h-o)**2;if(c===0)return Math.sqrt((i-a)**2+(n-o)**2);let d=((i-a)*(r-a)+(n-o)*(h-o))/c;return d=Math.max(0,Math.min(1,d)),Math.sqrt((i-(a+d*(r-a)))**2+(n-(o+d*(h-o)))**2)}static IsValid(e){return Array.isArray(e)&&typeof e[0]=="number"&&typeof e[1]=="number"&&isFinite(e[0])&&isFinite(e[1])}static IsValids(e){return Array.isArray(e)&&e.every(t=>this.IsValid(t))}}l(x,"HALF_PI",Math.PI/2),l(x,"PI_OVER_180",Math.PI/180),l(x,"EARTH_RADIUS",6378137),l(x,"MAX_LAT",85.05112878);class S extends w{constructor(t){super(t);l(this,"textOffset",{x:0,y:0});l(this,"extraOffset");l(this,"text");this.text=String(t.text),this.extraOffset=t.extraOffset}notifyDraggable(t,s){var a;if(!this.isInteractable||!this.mainCanvas||!this.draggable)return;const{x:i,y:n}=super.notifyDraggable(t,s);this.value=[this.value[0]+i.value,this.value[1]+n.value],this.position=[this.position[0]+i.position,this.position[1]+n.position],this.dynamicPosition=[this.dynamicPosition[0]+i.dynamicPosition,this.dynamicPosition[1]+n.dynamicPosition],(a=this.notifyReload)==null||a.call(this)}notifyHover(t,s,i){var n;this.isInteractable&&(super.notifyHover(t,s,i),(n=this.notifyReload)==null||n.call(this))}isPointInPath(t,s){return this.path?w.ctx.isPointInPath(this.path,t,s):!1}isPointInStroke(t,s){return!1}updateBaseData(){if(!this.mainCanvas)return;if(!this.text||this.text.length==0)return this.dynamicPosition=void 0;const t=x.IsValid;let{value:s,position:i}=this;const[n,a]=[t(s),t(i)];if(!n&&!a)return this.dynamicPosition=void 0;if(n){const c=this.mainCanvas.getAxisPointByValue(s[0],s[1],!0);i=[c.x,c.y]}else{const c=this.mainCanvas.getAxisValueByPoint(i[0],i[1],!0);s=[c.xV,c.yV]}const o=this.mainCanvas.transformPosition([i])[0];this.dynamicPosition=o,this.value=s,this.position=i;const r=this.mainCanvas.ctx;this.setCanvasStyles(r);const h=r.measureText(this.text);this.textOffset={x:h.width/2,y:h.actualBoundingBoxAscent/2}}setText(t){var s;t!=this.text&&(this.text=t,this.updateBaseData(),this.dynamicPosition&&((s=this.notifyReload)==null||s.call(this)))}setExtraOffset(t){var s;this.extraOffset=t,(s=this.notifyReload)==null||s.call(this)}setCanvasStyles(t){var a;const s=this.mainCanvas,i=s.style[s.theme].text;let n={};typeof this.style=="string"?n=((a=s.style[this.style])==null?void 0:a.text)||i:typeof this.style=="object"?n=Object.assign({},i,this.style):n=i,t.font=`${n.bold?"bold":""} ${n.size}px ${n.family}`,t.lineWidth=2,t.strokeStyle=n.stroke,t.fillStyle=n[this.isHover?"secondary":"color"]}draw(t){if(!this.mainCanvas)return;const s=this.dynamicPosition,i=this.textOffset,n=this.text,a=this.extraOffset||{x:0,y:0};this.setCanvasStyles(t);const o=s[0]+a.x-i.x,r=s[1]+a.y+i.y;t.strokeText(n,o,r),t.fillText(n,o,r),this.path=new Path2D,this.path.rect(o,s[1]+a.y-i.y,i.x*2,i.y*2)}getDraw(){const{show:t,dynamicPosition:s,position:i,value:n,textOffset:a,mainCanvas:o}=this;if(!o)return;const{scale:r,maxMinValue:h,isRecalculate:c}=o;if(t.shouldRender(r)&&s){const[u,y]=n;if(h.maxXV>u-a.x&&h.minXV<u+a.x&&h.maxYV>y-a.y&&h.minYV<y+a.y)return c&&(this.dynamicPosition=o.transformPosition([i])[0]),[this.draw,this]}}}class b extends w{constructor(t){super(t);l(this,"radiusValue",0);l(this,"angle",2*Math.PI);l(this,"fillProgress")}notifyDraggable(t,s){var a;if(!this.isInteractable||!this.mainCanvas||!this.draggable)return;const{x:i,y:n}=super.notifyDraggable(t,s);this.value=[this.value[0]+i.value,this.value[1]+n.value],this.position=[this.position[0]+i.position,this.position[1]+n.position],this.dynamicPosition=[this.dynamicPosition[0]+i.dynamicPosition,this.dynamicPosition[1]+n.dynamicPosition],(a=this.notifyReload)==null||a.call(this)}notifyHover(t,s,i){if(!this.isInteractable)return;super.notifyHover(t,s,i);const n=300,a=this.setCanvasStyles().width;this.fillProgress?this.cancelAndRestartAnimation(t,a,n-100):t&&this.startNewHoverAnimation(a,n)}cancelAndRestartAnimation(t,s,i){this.fillProgress.scheduleCallback();let n=0;this.fillProgress.scheduleCallback=L(a=>{!this.fillProgress||!a||(this.fillProgress.progress+=(a-n)*(t?1:-1),n=a,this.fillProgress.progress=Math.min(1,Math.max(0,this.fillProgress.progress)),this.updateLineWidthOffset(s),(this.fillProgress.progress===1||this.fillProgress.progress===0)&&(this.fillProgress.scheduleCallback(),this.fillProgress.progress===0&&(this.fillProgress=void 0)))},i)}startNewHoverAnimation(t,s){this.fillProgress={lineWidthOffset:0,progress:0,scheduleCallback:L(i=>{this.fillProgress&&(this.fillProgress.progress=i,this.updateLineWidthOffset(t))},s)}}updateLineWidthOffset(t){var i;if(!this.fillProgress)return;const s=Math.ceil(t*this.fillProgress.progress);s!==this.fillProgress.lineWidthOffset&&(this.fillProgress.lineWidthOffset=s,(i=this.notifyReload)==null||i.call(this))}isPointInPath(t,s){return this.path?w.ctx.isPointInPath(this.path,t,s):!1}isPointInStroke(t,s){var i;if(this.path&&this.mainCanvas){const{width:n}=this.setCanvasStyles(w.ctx);return((i=this.fillProgress)==null?void 0:i.lineWidthOffset)==n?!1:w.ctx.isPointInStroke(this.path,t,s)}return!1}updateBaseData(){var d;if(!this.mainCanvas)return;const t=x.IsValid;let{value:s,position:i}=this;const[n,a]=[t(s),t(i)];if(!n&&!a)return this.dynamicPosition=void 0;if(n){const u=this.mainCanvas.getAxisPointByValue(s[0],s[1],!0);i=[u.x,u.y]}else{const u=this.mainCanvas.getAxisValueByPoint(i[0],i[1],!0);s=[u.xV,u.yV]}const o=this.mainCanvas.transformPosition([i])[0];this.dynamicPosition=o,this.value=s,this.position=i;const r=this.mainCanvas.style[this.mainCanvas.theme].point;let h={};typeof this.style=="string"?h=(d=this.mainCanvas.style[this.style])==null?void 0:d.point:typeof this.style=="object"&&(h=this.style);const c=((h==null?void 0:h.width)||r.width)+((h==null?void 0:h.radius)||r.radius);this.radiusValue=this.mainCanvas.preservePrecision(s[0]/i[0]*c)}setCanvasStyles(t){var h,c;const s=this.mainCanvas,i=s.style[s.theme].point;let n={};typeof this.style=="string"?n=((h=s.style[this.style])==null?void 0:h.point)||i:typeof this.style=="object"?n=Object.assign({},i,this.style):n=i;const{width:a,stroke:o,fill:r}=n;if(t){const d=((c=this.fillProgress)==null?void 0:c.lineWidthOffset)||0;t.lineWidth=a-d,t.strokeStyle=o,t.fillStyle=r}return{...n}}draw(t){var r;const{dynamicPosition:s,mainCanvas:i}=this;if(!i)return;const{radius:n,width:a}=this.setCanvasStyles(t),o=((r=this.fillProgress)==null?void 0:r.lineWidthOffset)||0;t.beginPath(),this.path=new Path2D,this.path.arc(s[0],s[1],n+o/2,0,this.angle),t.fill(this.path),a!=o&&t.stroke(this.path)}getDraw(){const{show:t,dynamicPosition:s,position:i,value:n,radiusValue:a,mainCanvas:o}=this;if(!o)return;const{scale:r,maxMinValue:h,isRecalculate:c}=o;if(t.shouldRender(r)&&!!s){const[y,v]=n;if(h.maxXV>y-a&&h.minXV<y+a&&h.maxYV>v-a&&h.minYV<v+a)return c&&(this.dynamicPosition=o.transformPosition([i])[0]),[this.draw,this]}}}function F(p,e,t=10){if(e.length===0)return 0;if(e.length===1)return 1;let s=1/0,i=-1;for(let n=0;n<e.length-1;n++){const a=x.PointToLineDistance(p,e[n],e[n+1]);if(a<t)return n+1;a<s&&(s=a,i=n+1)}return i}function H(p,e){const{x:t,y:s}=T(...p,...e);return[t,s]}class z extends w{constructor(t){super(t);l(this,"handlePoints",[]);l(this,"isShowHandlePoint",!0);l(this,"canCreateOrDeleteHandlePoint",!0);l(this,"lockedCanCreateOrDeleteHandlePoint",!1);this.isShowHandlePoint=t.isShowHandlePoint??!0,this.canCreateOrDeleteHandlePoint=t.canCreateOrDeleteHandlePoint??!0}notifyHover(t,s,i){this.isInteractable&&super.notifyHover(t,s,i)}notifyClick(t,s,i){var a;if(!this.isInteractable)return;const n=this.isClick;if(super.notifyClick(t,s,i),this.lockedCanCreateOrDeleteHandlePoint)this.resetHandlePointLock();else if(n&&this.isClick&&this.isShowHandlePoint&&this.canCreateOrDeleteHandlePoint&&this.draggable){const r=this.handlePoints.findIndex(h=>h.isHover);r===-1?this.tryCreateNewHandlePoint(s,i):this.tryDeleteHandlePoint(r)}(a=this.notifyReload)==null||a.call(this)}tryCreateNewHandlePoint(t,s){if(this.isDblClick||!this.isPointInStroke(t,s))return;const i=this.getExtendedDynamicPositions(),n=F([t,s],i);if(n===-1)return;const[a,o]=this.getAdjacentIndices(n),r=this.createNewHandlePoint(a,o);this.insertHandlePoint(n,r),this.lockHandlePointCreationTemporarily()}tryDeleteHandlePoint(t){!this.isDblClick||!this.canDeleteHandlePoint||this.deleteHandlePoint(t)}getExtendedDynamicPositions(){return this.isClosed?[...this.dynamicPosition,this.dynamicPosition[0]]:this.dynamicPosition}getAdjacentIndices(t){const s=t-1,i=this.isClosed&&t===this.dynamicPosition.length?0:t;return[s,i]}createNewHandlePoint(t,s){const i=H(this.value[t],this.value[s]),n=H(this.position[t],this.position[s]),a=H(this.dynamicPosition[t],this.dynamicPosition[s]);return new b({value:i,position:n,dynamicPosition:a,draggable:!0,mainCanvas:this.mainCanvas,notifyReload:()=>{var o;return(o=this.notifyReload)==null?void 0:o.call(this)}})}insertHandlePoint(t,s){this.handlePoints.splice(t,0,s),this.value.splice(t,0,s.value),this.position.splice(t,0,s.position),this.dynamicPosition.splice(t,0,s.dynamicPosition)}deleteHandlePoint(t){this.handlePoints.splice(t,1),this.value.splice(t,1),this.position.splice(t,1),this.dynamicPosition.splice(t,1)}lockHandlePointCreationTemporarily(){this.lockedCanCreateOrDeleteHandlePoint=!0,setTimeout(()=>{this.lockedCanCreateOrDeleteHandlePoint=!1},300)}resetHandlePointLock(){this.lockedCanCreateOrDeleteHandlePoint=!1}get canDeleteHandlePoint(){return this.handlePoints.length>this.minNeededHandlePoints}notifyDraggable(t,s){if(!this.isInteractable||!this.draggable)return;const i=()=>{var o;const{x:n,y:a}=super.notifyDraggable(t,s);this.value.forEach((r,h)=>{this.value[h][0]+=n.value,this.value[h][1]+=a.value,this.position[h][0]+=n.position,this.position[h][1]+=a.position,this.dynamicPosition[h][0]+=n.dynamicPosition,this.dynamicPosition[h][1]+=a.dynamicPosition}),this.handlePoints.forEach((r,h)=>{r.value=this.value[h],r.position=this.position[h],r.dynamicPosition=this.dynamicPosition[h]}),(o=this.notifyReload)==null||o.call(this),this.lockedCanCreateOrDeleteHandlePoint=!0};if(this.isShowHandlePoint){const n=this.handlePoints.findIndex(a=>a.isHover);if(n!=-1){const a=this.handlePoints[n];a.notifyDraggable(t,s),this.value[n]=a.value,this.position[n]=a.position,this.dynamicPosition[n]=a.dynamicPosition}else i()}else i()}updateHandlePoints(){let{value:t,position:s,dynamicPosition:i}=this;i&&(t==null||t.forEach((n,a)=>{const o=this.handlePoints[a]||new b({draggable:!0});o.value=t[a],o.position=s[a],o.dynamicPosition=i[a],o.mainCanvas=this.mainCanvas,o.setNotifyReload(()=>{var r;return(r=this.notifyReload)==null?void 0:r.call(this)}),this.handlePoints[a]||this.handlePoints.push(o)}),this.handlePoints.length=t.length)}}class I extends z{constructor(t){super(t);l(this,"infinite");l(this,"isClosed",!1);l(this,"minNeededHandlePoints",2);this.infinite=t.infinite,this.canCreateOrDeleteHandlePoint=!t.infinite}notifyClick(t,s,i){!this.isInteractable||t&&!this.isShowHandlePoint||this.infinite||super.notifyClick(t,s,i)}isPointInPath(t,s){return!1}isPointInStroke(t,s){return this.path&&this.mainCanvas?(this.setCanvasStylesLine(w.ctx),this.draggable&&(w.ctx.lineWidth=Math.max(w.ctx.lineWidth,20)),w.ctx.isPointInStroke(this.path,t,s)):!1}isPointInAnywhere(t,s){const i=super.isPointInAnywhere(t,s),n=(this.isClick||!!this.infinite)&&this.isShowHandlePoint&&this.handlePoints.some(a=>{const o=a.isPointInAnywhere(t,s);return a.notifyHover(o,t,s),o});return i||n}updateBaseData(){if(!this.mainCanvas)return;let{value:t,position:s}=this;const[i,n]=[x.IsValids(t)&&t.length>1,x.IsValids(s)&&s.length>1];if(!i&&!n)return this.handlePoints=[],this.dynamicPosition=void 0;if(i){s=[];for(let o=0;o<t.length;o++){const r=t[o],h=this.mainCanvas.getAxisPointByValue(r[0],r[1],!0);s.push([h.x,h.y])}}else{t=[];for(let o=0;o<s.length;o++){const r=s[o],h=this.mainCanvas.getAxisValueByPoint(r[0],r[1],!0);t.push([h.xV,h.yV])}}const a=this.mainCanvas.transformPosition(s);this.dynamicPosition=a,this.value=t,this.position=s,this.updateHandlePoints()}setInfinite(t){var s;t!=this.infinite&&(this.infinite=t,this.canCreateOrDeleteHandlePoint=!t,this.dynamicPosition&&((s=this.notifyReload)==null||s.call(this)))}setCanvasStylesLine(t){var y;const s=this.mainCanvas,i=s.style[s.theme].line;let n={};typeof this.style=="string"?n=((y=s.style[this.style])==null?void 0:y.line)||i:typeof this.style=="object"?n=Object.assign({},i,this.style):n=i;const{width:a,color:o,dash:r,dashGap:h,dashOffset:c,cap:d,join:u}=n;return t&&(t.setLineDash(r?h:[]),t.lineDashOffset=c,t.lineCap=d,t.lineJoin=u,t.lineWidth=a,t.strokeStyle=o),n}drawLine(t,s){const{mainCanvas:i,infinite:n,isClick:a}=this;if(s=s||this.dynamicPosition,!i)return;const o=this.setCanvasStylesLine(t);t.beginPath(),this.path=new Path2D,s.forEach((r,h)=>{this.path[h==0?"moveTo":"lineTo"](r[0],r[1])}),t.stroke(this.path),(n||a)&&this.isShowHandlePoint&&this.handlePoints.forEach(r=>{r.style=o.point,r.draw(t)})}drawInfiniteStraightLine(t){const{mainCanvas:s,dynamicPosition:i}=this;if(!s)return;const{rect:n}=s,[a,o]=G(i),r=[o[0]-a[0],o[1]-a[1]];if(r[0]===0&&r[1]===0)return console.error("重合点无法确定方向");const h=(u,y)=>{const[v,f]=u,[m,P]=y;let g=1/0;if(m!==0){const C=m>0?(n.value.width-v)/m:-v/m;C>0&&(g=Math.min(g,C))}if(m!==0){const C=m>0?(n.value.width-v)/m:-v/m;C>0&&(g=Math.min(g,C))}return g===1/0?u:[v+m*g,f+P*g]},c=h(a,[-r[0],-r[1]]),d=h(o,r);this.drawLine(t,[c,d])}getDraw(){const{show:t,dynamicPosition:s,position:i,infinite:n,mainCanvas:a}=this;if(!a)return;const{scale:o,isRecalculate:r}=a;if(t.shouldRender(o)&&!!s)return r&&(this.dynamicPosition=a.transformPosition(i),this.handlePoints.forEach((d,u)=>d.dynamicPosition=this.dynamicPosition[u])),n?[this.drawInfiniteStraightLine,this]:[this.drawLine,this]}}class A extends z{constructor(t){super(t);l(this,"isRect",!1);l(this,"isClosed",!0);l(this,"minNeededHandlePoints",3);this.isRect=t.isRect??!1,this.canCreateOrDeleteHandlePoint=!t.isRect}notifyHover(t,s,i){var n;this.isInteractable&&(super.notifyHover(t,s,i),(n=this.notifyReload)==null||n.call(this))}notifyClick(t,s,i){!this.isInteractable||t&&!this.isShowHandlePoint||super.notifyClick(t,s,i)}isPointInPath(t,s){return this.path?w.ctx.isPointInPath(this.path,t,s):!1}isPointInStroke(t,s){return this.path&&this.mainCanvas?(this.setCanvasStyles(w.ctx),this.draggable&&(w.ctx.lineWidth=Math.max(w.ctx.lineWidth,20)),w.ctx.isPointInStroke(this.path,t,s)):!1}isPointInAnywhere(t,s){const i=super.isPointInAnywhere(t,s),n=this.isClick&&this.isShowHandlePoint&&this.handlePoints.some(a=>{const o=a.isPointInAnywhere(t,s);return a.notifyHover(o,t,s),o});return i||n}updateBaseData(){if(!this.mainCanvas)return;let{value:t,position:s,isRect:i}=this,[n,a]=[x.IsValids(t)&&t.length>(i?1:2),x.IsValids(s)&&s.length>(i?1:2)];if(!n&&!a)return this.dynamicPosition=void 0;if(i){if(n){t.length=2;const[r,h]=t;n=!(r[0]==h[0]||r[1]==h[1])}if(a){s.length=2;const[r,h]=s;a=!(r[0]==h[0]||r[1]==h[1])}}if(n){s=[];for(let r=0;r<t.length;r++){const h=t[r],c=this.mainCanvas.getAxisPointByValue(h[0],h[1],!0);s.push([c.x,c.y])}}else{t=[];for(let r=0;r<s.length;r++){const h=s[r],c=this.mainCanvas.getAxisValueByPoint(h[0],h[1],!0);t.push([c.xV,c.yV])}}const o=this.mainCanvas.transformPosition(s);this.dynamicPosition=o,this.value=t,this.position=s,this.updateHandlePoints()}setRect(t){var s;if(this.isRect!=t){this.isRect=t,this.canCreateOrDeleteHandlePoint=!t;const i=!!this.dynamicPosition;this.updateBaseData(),(this.dynamicPosition||i)&&((s=this.notifyReload)==null||s.call(this))}}setCanvasStyles(t){var f;const s=this.isHover,i=this.mainCanvas,n=i.style[i.theme].polygon;let a={};typeof this.style=="string"?a=((f=i.style[this.style])==null?void 0:f.polygon)||n:typeof this.style=="object"?a=Object.assign({},n,this.style):a=n;const{width:o,stroke:r,dash:h,dashGap:c,dashOffset:d,fill:u,fill_hover:y,stroke_hover:v}=a;return t.setLineDash(h?c:[]),t.lineDashOffset=d,t.lineWidth=o,t.strokeStyle=s?v:r,t.fillStyle=s?y:u,a}drawRect(t){const[[s,i],[n,a]]=this.dynamicPosition,o=Math.abs(n-s),r=Math.abs(a-i),h=Math.min(s,n),c=Math.min(i,a),d=this.setCanvasStyles(t);t.beginPath(),this.path=new Path2D,this.path.rect(h,c,o,r),t.stroke(this.path),t.fill(this.path),this.isClick&&this.isShowHandlePoint&&this.handlePoints.forEach(u=>{u.style=d.point,u.draw(t)})}drawPolygon(t){const s=this.dynamicPosition,i=this.setCanvasStyles(t);t.beginPath(),this.path=new Path2D,s.forEach((n,a)=>{this.path[a==0?"moveTo":"lineTo"](n[0],n[1])}),this.path.lineTo(s[0][0],s[0][1]),t.closePath(),t.stroke(this.path),t.fill(this.path),this.isClick&&this.isShowHandlePoint&&this.handlePoints.forEach(n=>{n.style=i.point,n.draw(t)})}getDraw(){const{show:t,dynamicPosition:s,position:i,mainCanvas:n}=this;if(!n)return;const{scale:a,isRecalculate:o}=n;if(t.shouldRender(a)&&!!s)return o&&(this.dynamicPosition=n.transformPosition(i),this.handlePoints.forEach((c,d)=>c.dynamicPosition=this.dynamicPosition[d])),this.isRect?[this.drawRect,this]:[this.drawPolygon,this]}}class V extends w{constructor(t,s){super(t);l(this,"multiple");l(this,"draw");this.draw=s}notifyDraggable(t,s){}isPointInPath(t,s){return!1}isPointInStroke(t,s){return!1}isMultiple(){if(!this.mainCanvas)return;const t=x.IsValid,s=x.IsValids.bind(x);let{value:i,position:n}=this;const a=o=>{const r=o(i),h=o(n);return r||h?(r||(this.value=void 0),h||(this.position=void 0),!0):!1};return a(t)?this.multiple=!1:a(s)&&(this.multiple=!0),this.multiple}updateBaseData(){this.mainCanvas&&(this.isMultiple(),this.dynamicPosition=void 0,this.multiple===!0?this.handleMultipleData():this.multiple===!1&&this.handleSingleData())}handleMultipleData(){let t=this.value,s=this.position;t?s=this.convertValuesToPositions(t):t=this.convertPositionsToValues(s),this.updateDataProperties(t,s)}handleSingleData(){let t=this.value,s=this.position;if(t){const i=this.mainCanvas.getAxisPointByValue(t[0],t[1],!0);s=[i.x,i.y]}else{const i=this.mainCanvas.getAxisValueByPoint(s[0],s[1],!0);t=[i.xV,i.yV]}this.updateDataProperties(t,s)}convertValuesToPositions(t){const s=[];let i=1;return t.forEach((n,a)=>{if(a===0){const o=this.mainCanvas.getAxisPointByValue(n[0],n[1],!0);s.push([o.x,o.y]),i=this.mainCanvas.preservePrecision(o.x/n[0])}else s.push([this.mainCanvas.preservePrecision(i*n[0]),this.mainCanvas.preservePrecision(i*n[1])])}),s}convertPositionsToValues(t){const s=[];let i=1;return t.forEach((n,a)=>{if(a===0){const o=this.mainCanvas.getAxisValueByPoint(n[0],n[1],!0);s.push([o.xV,o.yV]),i=this.mainCanvas.preservePrecision(o.xV/n[0])}else s.push([this.mainCanvas.preservePrecision(i*n[0]),this.mainCanvas.preservePrecision(i*n[1])])}),s}updateDataProperties(t,s){this.dynamicPosition=this.multiple?this.mainCanvas.transformPosition(s):this.mainCanvas.transformPosition([s])[0],this.value=t,this.position=s}getDraw(){const{show:t,dynamicPosition:s,mainCanvas:i,multiple:n,position:a}=this;if(!i||typeof n!="boolean")return;const{scale:o,isRecalculate:r}=i;if(t.shouldRender(o)&&!!s)return r&&(this.dynamicPosition=n?i.transformPosition(a):i.transformPosition([a])[0]),[this.draw,this]}}class D{constructor(e){l(this,"name");l(this,"show",new M);l(this,"overlays",new Set);l(this,"mainCanvas");l(this,"notifyReload");this.name=e}equalsMainCanvas(e){return this.mainCanvas===e}setMainCanvas(e){var t;this.mainCanvas=e,this.overlays.forEach(s=>s.setMainCanvas(e)),e&&this.overlays.size&&((t=this.notifyReload)==null||t.call(this))}setNotifyReload(e){this.notifyReload=e?t=>{var s;(t||this.show.shouldRender((s=this.mainCanvas)==null?void 0:s.scale)&&this.overlays.size)&&e()}:void 0,this.overlays.forEach(t=>t.setNotifyReload(this.notifyReload)),this.show.notifyReload=this.notifyReload}addOverlays(e){var t;[e].flat().forEach(s=>{s.setNotifyReload(this.notifyReload),s.setMainCanvas(this.mainCanvas),this.overlays.add(s)}),(t=this.notifyReload)==null||t.call(this)}hasOverlay(e){return this.overlays.has(e)}removeOverlays(e){var t;[e].flat().forEach(s=>{this.overlays.delete(s),s.setNotifyReload(),s.setMainCanvas()}),(t=this.notifyReload)==null||t.call(this)}clearOverlays(){var e;(e=this.notifyReload)==null||e.call(this),this.overlays.forEach(t=>{t.setNotifyReload(),t.setMainCanvas()}),this.overlays.clear()}getOverlaysDrawingMethod(){var t;const e=[];if(this.show.shouldRender((t=this.mainCanvas)==null?void 0:t.scale)&&this.overlays.size){let s=1;Array.from(this.overlays.values()).sort((i,n)=>i.zIndex-n.zIndex).forEach(i=>{if(i.equalsMainCanvas(this.mainCanvas)){const n=i.getDraw();n&&e.push([(Number(i.zIndex)||0)+s++,n])}else this.overlays.delete(i)})}return e}}class O{constructor(e){l(this,"name");l(this,"show",new M);l(this,"opacity",1);l(this,"zIndex",4);l(this,"canvas",document.createElement("canvas"));l(this,"ctx",this.canvas.getContext("2d"));l(this,"isReload",!1);l(this,"groups",new Map);l(this,"mainCanvas");l(this,"notifyReload");l(this,"currentDrawOverlays",[]);this.name=e}equalsMainCanvas(e){return this.mainCanvas===e}setMainCanvas(e){var t,s;this.mainCanvas=e,this.canvas.width=((t=e==null?void 0:e.rect)==null?void 0:t.value.width)||0,this.canvas.height=((s=e==null?void 0:e.rect)==null?void 0:s.value.height)||0,this.groups.forEach(i=>i.setMainCanvas(e))}setNotifyReload(e){this.notifyReload=e?t=>{var s;(t||this.show.shouldRender((s=this.mainCanvas)==null?void 0:s.scale)&&this.groups.size)&&e()}:void 0,this.groups.forEach(t=>this.setGroupNotifyReload(t)),this.show.notifyReload=this.notifyReload}setGroupNotifyReload(e){e.setNotifyReload(this.notifyReload?()=>{var t;(t=this.notifyReload)==null||t.call(this),this.isReload=!0}:void 0)}getGroup(e){return this.groups.get(e)}addGroup(e){[e].flat().forEach(t=>{t instanceof D&&(this.setGroupNotifyReload(t),t.setMainCanvas(this.mainCanvas),this.groups.set(t.name,t))})}removeGroup(e){var s;let t=!1;[e].flat().forEach(i=>{i instanceof D&&(this.groups.delete(i.name),i.setNotifyReload(),i.setMainCanvas(),t=!0)}),t&&((s=this.notifyReload)==null||s.call(this))}clearGroup(){var e;this.groups.size&&(this.groups.forEach(t=>{t.setNotifyReload(),t.setMainCanvas()}),this.groups.clear(),(e=this.notifyReload)==null||e.call(this))}setzIndex(e){var t;e!=this.zIndex&&(this.zIndex=e,(t=this.notifyReload)==null||t.call(this,!1))}setOpacity(e){var t;this.opacity!=e&&(e>=0&&e<=1?(this.opacity=e,(t=this.notifyReload)==null||t.call(this,!1)):console.warn("Opacity value should be between 0 and 1."))}getCanvas(){if(!this.mainCanvas)return;const{scale:e,rect:t,isRecalculate:s,isThemeUpdated:i}=this.mainCanvas,n=this.show.shouldRender(e),a=this.groups.size;if(n&&a){if(this.isReload||s||i){this.currentDrawOverlays=[],this.isReload=!1,this.canvas.width=(t==null?void 0:t.value.width)||0,this.canvas.height=(t==null?void 0:t.value.height)||0;const o=[];this.groups.forEach(r=>{r.equalsMainCanvas(this.mainCanvas)?o.push(...r.getOverlaysDrawingMethod()):this.groups.delete(r.name)}),o.sort((r,h)=>r[0]-h[0]),o.forEach(([r,[h,c]])=>{h.call(c,this.ctx),this.currentDrawOverlays.push([[Number(this.zIndex)||0,r],c])})}return[Number(this.zIndex)||0,this.canvas,this.currentDrawOverlays]}}}class k{constructor(e){l(this,"name");l(this,"show",new M);l(this,"layers",new Map);l(this,"mainCanvas");l(this,"notifyReload");this.name=e}setMainCanvas(e){this.mainCanvas=e,this.layers.forEach(t=>t.setMainCanvas(e))}setNotifyReload(e){this.notifyReload=e?t=>{var s;(t||this.show.shouldRender((s=this.mainCanvas)==null?void 0:s.scale)&&this.layers.size)&&e()}:void 0,this.layers.forEach(t=>t.setNotifyReload(this.notifyReload)),this.show.notifyReload=this.notifyReload}getLayer(e){return this.layers.get(e)}addLayer(e){[e].flat().forEach(t=>{t instanceof O&&(t.setNotifyReload(this.notifyReload),t.setMainCanvas(this.mainCanvas),this.layers.set(t.name,t))})}removeLayer(e){var s;let t=!1;[e].flat().forEach(i=>{i instanceof O&&(this.layers.delete(i.name),i.setNotifyReload(),i.setMainCanvas(),t=!0)}),t&&((s=this.notifyReload)==null||s.call(this))}clearLayers(){var e;this.layers.size&&(this.layers.forEach(t=>{t.setNotifyReload(),t.setMainCanvas()}),this.layers.clear(),(e=this.notifyReload)==null||e.call(this))}fetchCanvas(){var e;if(this.show.shouldRender((e=this.mainCanvas)==null?void 0:e.scale)&&this.layers.size){const t=[];return this.layers.forEach(s=>{if(s.equalsMainCanvas(this.mainCanvas)){const i=s.getCanvas();i&&t.push(i)}else this.layers.delete(s.name)}),t}return[]}}class U{constructor(e){l(this,"canvas");l(this,"ctx");l(this,"rect");l(this,"offset",{x:0,y:0});l(this,"center",{x:0,y:0});l(this,"defaultCenter",{top:void 0,bottom:void 0,left:void 0,right:void 0});l(this,"lockDragAndResize",!1);l(this,"accuracy",5);l(this,"scale",1);l(this,"percentage",1);l(this,"axisConfig",{count:2,min:100,max:200,size:100,x:1,y:1});l(this,"cycle",10);l(this,"delta",.02);l(this,"redrawInNextRenderFrame",!1);l(this,"isAuto",!1);l(this,"isRendering",!1);l(this,"drawAxis");l(this,"layerGroups",new Map);l(this,"nowGridCount");const t=document.getElementById(e);if(t instanceof HTMLCanvasElement)if(t.getContext){this.canvas=t,this.ctx=t.getContext("2d"),this.rect=(n=>{let a=!0;Promise.resolve().then(()=>a=!1);const o={value:n.getBoundingClientRect()};return new Proxy(o,{get(r,h){return h=="value"?(a||(r.value=n.getBoundingClientRect(),a=!0,Promise.resolve().then(()=>a=!1)),r.value):r[h]},set(){return!1}})})(t);const{clientWidth:s,clientHeight:i}=t;[t.width,t.height]=[s,i]}else throw new Error("canvas-unsupported code here");else throw new Error("canvas is not HTMLCanvasElement")}updateCenter(){const{canvas:e,rect:t,offset:s,defaultCenter:i}=this;if(!e)return console.error("canvas is not HTMLCanvasElement");const{width:n,height:a}=t.value,{top:o,bottom:r,left:h,right:c}=i,d={vertical:(f,m)=>{if([0,"0","0%"].includes(f))return 0;if(!(f==1/0||f==-1/0))return typeof f=="number"?f:["top","left"].includes(f)?0:["bottom","right"].includes(f)?m:["middle","center"].includes(f)?m/2:/^(\d+)%$/.test(f)?(f=f.match(/^(\d+)%$/)[1],m*Number(f)/100):Number(f)||void 0},reverse:(f,m)=>{if([0,"0","0%"].includes(f))return m;if(f==1/0||f==-1/0)return;if(typeof f=="number")return m-f;const P=d.vertical(f,m);return P?m-P:void 0}},u=(f,m,P)=>{if(f!==void 0){const g=d.vertical(f,P);if(g!==void 0)return g}if(m!==void 0){const g=d.reverse(m,P);if(g!==void 0)return g}return P/2},y=u(o,r,a),v=u(h,c,n);this.center={x:Math.floor(v+s.x),y:Math.floor(y+s.y)}}updateSize(){const{scale:e,cycle:t,delta:s,axisConfig:i}=this;let n=Math.abs(e-1)%(t*s)/s;n=Math.round(e<1?t-n:n),i.size=n/t*(i.max-i.min)+i.min,this.percentage=this.getAxisPointByValue(i.count,0).x/i.min}setScale(e,t){const{canvas:s,lockDragAndResize:i,axisConfig:n}=this,a=this.rect.value;if(i)return;if(!s||!a)return console.error("canvas is not HTMLCanvasElement");let o,r;e==="center"?(o=a.left+a.width/2,r=a.top+a.height/2):[o,r]=[e.clientX,e.clientY];const h=this.getMousePositionOnAxis({clientX:o,clientY:r}),c=this.getAxisValueByPoint(h.x,h.y);this.scale=this.preservePrecision(this.scale+t),this.updateSize();const d=this.getAxisPointByValue(c.xV,c.yV);this.offset.x-=(d.x-h.x)*n.x,this.offset.y-=(d.y-h.y)*n.y}setAxis(e){const t={...this.axisConfig,...e},s=Object.fromEntries(Object.entries(t).map(([f,m])=>[f,Number(m)])),{x:i,y:n,count:a,min:o,max:r,size:h}=s,c=[1,-1].includes(i),d=[1,-1].includes(n),u=a>0,y=o>0&&o<r,v=h>=o&&h<=r;if(!c||!d||!u||!y||!v){console.warn("Invalid axis configuration:",{x:i,y:n,count:a,min:o,max:r,size:h});return}this.axisConfig=s}setDefaultCenter(e){Object.assign(this.defaultCenter,e)}getGridCount(){const{axisConfig:e,scale:t,cycle:s,delta:i,nowGridCount:n,isRendering:a}=this,o=e.count;if(n&&a)return n;const r=s*i;if(t===1)this.nowGridCount=o;else if(t>1)this.nowGridCount=o/Math.pow(2,Math.floor((t-1)/r));else{const h=(1-t)/r;this.nowGridCount=o*Math.pow(2,Number.isInteger(h)?h+1:Math.ceil(h))}return a&&Promise.resolve().then(()=>this.nowGridCount=void 0),this.nowGridCount}getMousePositionOnAxis(e){const{canvas:t,center:s,rect:i,axisConfig:n}=this;if(!t)return console.error("canvas is not HTMLCanvasElement");const{clientX:a,clientY:o}=e,{left:r,top:h}=i.value,c=(a-r-s.x)*n.x,d=(o-h-s.y)*n.y;return{x:c,y:d}}getAxisValueByPoint(e,t,s){const{axisConfig:i}=this;if(s)return{xV:e/i.min*i.count,yV:t/i.min*i.count};const n=this.getGridCount(),a=this.preservePrecision(e/i.size*n),o=this.preservePrecision(t/i.size*n);return{xV:a,yV:o}}getAxisPointByValue(e,t,s){const{axisConfig:i}=this;if(s)return{x:e/i.count*i.min,y:t/i.count*i.min};const n=this.getGridCount(),a=this.preservePrecision(e/n*i.size,3),o=this.preservePrecision(t/n*i.size,3);return{x:a,y:o}}getMaxMinValue(e){e=e||this.rect.value;const{left:t,top:s,right:i,bottom:n}=e,{axisConfig:a}=this,{x:o,y:r}=this.getMousePositionOnAxis({clientX:a.x==1?t:i,clientY:a.y==1?s:n}),{xV:h,yV:c}=this.getAxisValueByPoint(o,r),{x:d,y:u}=this.getMousePositionOnAxis({clientX:a.x==1?i:t,clientY:a.y==1?n:s}),{xV:y,yV:v}=this.getAxisValueByPoint(d,u);return{minXV:h,maxXV:y,minYV:c,maxYV:v}}preservePrecision(e,t){return x.PreservePrecision(e,t||this.accuracy)}transformPosition(e){const{center:t,percentage:s,axisConfig:i}=this,n=[];for(let a=0;a<e.length;a++){let[o,r]=e[a];o=t.x+o*s*i.x,r=t.y+r*s*i.y,n.push([o,r])}return n}}class $ extends U{constructor(t){super(t);l(this,"theme","light");l(this,"isThemeUpdated",!1);l(this,"style",{light:{background:"#fff",text:{color:"#222",secondary:"#909399",stroke:"#fff",size:12,family:"monospace",bold:!0},grid:{axis:"#222",grid:"#666",innerGrid:"#e5e5e5"},point:{radius:5,fill:"#d03050",width:14,stroke:"#d0305080"},line:{color:"#f0a020",width:4,dash:!1,dashGap:[5,10],dashOffset:0,cap:"round",join:"round",point:{radius:5,stroke:"#f0a02080",width:14,fill:"#f0a020"}},polygon:{fill:"#18a05830",stroke:"#18a058",fill_hover:"#03693360",stroke_hover:"#036933",width:1,dash:!1,dashGap:[5,10],dashOffset:0,point:{radius:5,stroke:"#03693380",width:14,fill:"#036933"}}},dark:{background:"#000",text:{color:"#aeaeae",secondary:"#8c8c8c",stroke:"#000",size:12,family:"monospace",bold:!0},grid:{axis:"#aeaeae",grid:"#666",innerGrid:"#454545"},point:{radius:5,fill:"#e88080",width:14,stroke:"#e8808070"},line:{color:"#f2c97d",width:4,dash:!1,dashGap:[5,10],dashOffset:0,cap:"round",join:"round",point:{radius:5,stroke:"#f2c97d80",width:14,fill:"#f2c97d"}},polygon:{fill:"#63e2b730",stroke:"#63e2b7",fill_hover:"#7efbd160",stroke_hover:"#7efbd1",width:1,dash:!1,dashGap:[5,10],dashOffset:0,point:{radius:5,stroke:"#7efbd180",width:14,fill:"#7efbd1"}}}});this.initStyle(),this.clearScreen()}initStyle(){const{canvas:t,ctx:s,theme:i}=this;t.classList.add("_nhanh_canvas");const n=this.style[i];s.font=`${n.text.bold?"bold":""} ${n.text.size}px ${n.text.family}`}clearScreen(){const{ctx:t,theme:s,rect:i}=this,{width:n,height:a}=i.value;t.fillStyle=this.style[s].background,t.fillRect(0,0,n,a)}setStyle(t){for(const s in t)if(Object.prototype.hasOwnProperty.call(t,s)){const i=G(this.style[s]||this.style[this.theme]);X(i,t[s]),this.style[s]=i}this.initStyle()}setTheme(t){t in this.style&&(this.theme=t,this.isThemeUpdated=!0)}}class q extends ${constructor(t){super(t);l(this,"resizeObserver");l(this,"currentDrawOverlays",[]);l(this,"rely","");l(this,"isRecalculate",!1);l(this,"notifyReload");l(this,"maxMinValue",{minXV:0,maxXV:0,minYV:0,maxYV:0});l(this,"measureRedrawPerformance",_(()=>this.redraw(),[[1,"#F56C6C"],[.5,"#E6A23C"],[0,"#67C23A"]]));this.canvas&&(this.resizeObserver=new ResizeObserver(Y(()=>{const s=this.rect.value;[this.canvas.width,this.canvas.height]=[s.width,s.height],this.redrawOnce()},200)),this.resizeObserver.observe(this.canvas)),this.updateRely(),this.isRecalculate=!1}updateRely(){const{center:t,scale:s,rect:i,axisConfig:n}=this,a=[t.x,t.y,s,JSON.stringify(n),i.value.width,i.value.height].join();this.isRecalculate=this.rely!==a,this.rely=a}redraw(){var n,a;if(!this.canvas)return console.error("canvas is not HTMLCanvasElement");if(this.canvas.clientWidth==0||this.canvas.clientHeight==0)return console.error("The image argument is a canvas element with a width or height of 0.");this.updateCenter(),this.updateRely(),this.maxMinValue=this.getMaxMinValue(),this.clearScreen();const t=[];let s=[];const i=(n=this.drawAxis)==null?void 0:n.drawAxisAndGrid();i&&s.push([0,i,[]]),this.layerGroups.forEach(o=>s=s.concat(o.fetchCanvas())),s.sort((o,r)=>o[0]-r[0]),s.forEach(([,o,r],h)=>{this.ctx.drawImage(o,0,0),r.forEach(([[c,d],u])=>{t.push([[c+h,d],u])})}),t.sort(([[o,r],h],[[c,d],u])=>{if(h.isClick)return-1;if(u.isClick)return 1;if(o!==c)return c-o;if(r!==d)return d-r;const y=v=>v instanceof V?0:v instanceof S?1:v instanceof b?2:v instanceof I?3:v instanceof A?4:5;return y(u)-y(h)}),this.currentDrawOverlays=t.map(([,o])=>o),this.isRecalculate=!1,this.isThemeUpdated=!1,(a=this.notifyReload)==null||a.call(this)}redrawOnce(t){this.isAuto&&!t&&(this.isAuto=!1),this.redrawInNextRenderFrame||(this.redrawInNextRenderFrame=!0,Promise.resolve().then(()=>{this.isRendering=!0,this.redrawInNextRenderFrame=!1,this.measureRedrawPerformance(),this.isRendering=!1}))}findOverlayByPoint(t,s){return this.currentDrawOverlays.find(i=>i.isPointInAnywhere(t,s))}destroy(){var t;(t=this.resizeObserver)==null||t.disconnect()}}class K extends q{constructor(t){super(t);l(this,"mouseInCanvas",!1);l(this,"mouseIsDown",!1);l(this,"mouseLastPosition",{x:0,y:0});l(this,"unBind");l(this,"lastClickedOverlay");l(this,"lastPressedKey",{key:"",keyupTime:0,dblclick:!1});l(this,"lastDownOverlay");l(this,"lastHoverOverlay");l(this,"oldClientX",[]);l(this,"oldClientY",[]);this.initEvent()}initEvent(){const{canvas:t}=this;if(!t)return console.error("canvas is not HTMLCanvasElement");const s=[{type:"click",handler:this.click.bind(this)},{type:"contextmenu",handler:this.contextmenu.bind(this)},{type:"mouseenter",handler:this.mouseenter.bind(this)},{type:"mouseleave",handler:this.mouseleave.bind(this)},{type:"keydown",handler:this.keydown.bind(this),target:window},{type:"keyup",handler:this.keyup.bind(this),target:window},{type:"wheel",handler:this.wheel.bind(this)},{type:"mousedown",handler:this.mousedown.bind(this)},{type:"mouseup",handler:this.mouseup.bind(this),target:window},{type:"mousemove",handler:this.mousemove.bind(this),target:window},{type:"touchend",handler:this.touchend.bind(this)},{type:"touchmove",handler:this.touchmove.bind(this)}];s.forEach(({type:i,handler:n,target:a=t})=>{a.addEventListener(i,n)}),this.unBind=()=>{s.forEach(({type:i,handler:n,target:a=t})=>{a.removeEventListener(i,n)})}}click(t){var i;const s=this.findOverlayByPoint(t.offsetX,t.offsetY);this.lastClickedOverlay!=s&&((i=this.lastClickedOverlay)==null||i.notifyClick(!1,t.offsetX,t.offsetY)),s==null||s.notifyClick(!0,t.offsetX,t.offsetY),this.lastClickedOverlay=s}contextmenu(t){var s;t.preventDefault(),console.log("mousecontextmenu"),(s=this.lastClickedOverlay)==null||s.notifyClick(!1,t.offsetX,t.offsetY),this.lastClickedOverlay=void 0}mouseenter(t){this.mouseInCanvas=!0}mouseleave(t){this.mouseInCanvas=!1}getStep(t){const{lastPressedKey:s}=this;return s.dblclick?4:s.key===t&&Date.now()-s.keyupTime<300?(s.dblclick=!0,4):1}keydown(t){const{mouseInCanvas:s,offset:i,delta:n,lockDragAndResize:a}=this,o=t.key;if(s&&!a){const r=this.getStep(o);switch(o){case"ArrowUp":i.y-=r;break;case"ArrowDown":i.y+=r;break;case"ArrowLeft":i.x-=r;break;case"ArrowRight":i.x+=r;break;case"+":this.setScale("center",n);break;case"-":this.setScale("center",-n);break}["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","+","-"].includes(o)&&this.redrawOnce()}}keyup(t){const{mouseInCanvas:s,lastPressedKey:i}=this;if(s){const n=t.key;i.key=n,i.keyupTime=Date.now(),i.dblclick=!1}}wheel(t){t.preventDefault();const{delta:s,lockDragAndResize:i}=this;i||(this.setScale(t,t.deltaY<0?s:-s),this.redrawOnce())}mousedown(t){var a;this.mouseIsDown=!0;const{clientX:s,clientY:i}=t;this.mouseLastPosition={x:s,y:i};const n=this.findOverlayByPoint(t.offsetX,t.offsetY);this.lastDownOverlay!=n&&((a=this.lastDownOverlay)==null||a.notifyDown(!1,t.offsetX,t.offsetY),n==null||n.notifyDown(!0,t.offsetX,t.offsetY)),this.lastDownOverlay=n}mouseup(t){this.mouseIsDown=!1,this.lastDownOverlay=void 0}mousemove(t){var h;const{clientX:s,clientY:i}=t,{mouseIsDown:n,offset:a,mouseLastPosition:o,lockDragAndResize:r}=this;if(n){if(r)return;(h=this.lastDownOverlay)!=null&&h.draggable?this.lastDownOverlay.notifyDraggable(s-o.x,i-o.y):(a.x+=s-o.x,a.y+=i-o.y,this.redrawOnce()),this.mouseLastPosition={x:s,y:i}}else{const c=this.rect.value,d=s-c.x,u=i-c.y;if(d<0||u<0||d>c.width||u>c.height)return;const y=this.findOverlayByPoint(t.offsetX,t.offsetY),v=f=>f.draggable?"_nhanh_canvas_hover_overlay_draggable":"_nhanh_canvas_hover_overlay";this.lastHoverOverlay!=y&&(this.lastHoverOverlay&&(this.canvas.classList.remove(v(this.lastHoverOverlay)),this.lastHoverOverlay.notifyHover(!1,t.offsetX,t.offsetY)),y&&(this.canvas.classList.add(v(y)),y.notifyHover(!0,t.offsetX,t.offsetY))),this.lastHoverOverlay=y}}touchend(t){this.oldClientX=this.oldClientY=[]}touchmove(t){const s=t.touches;t.preventDefault();const{oldClientX:i,oldClientY:n,offset:a,delta:o,lockDragAndResize:r}=this;if(!r){if(s.length===1){const{clientX:h,clientY:c}=s[0];i.length&&(a.x+=h-i[0],a.y+=c-n[0],this.redrawOnce()),this.oldClientX=[h],this.oldClientY=[c]}else if(s.length===2){const{clientX:h,clientY:c}=s[0],{clientX:d,clientY:u}=s[1];if(i.length==2){const y=E(i[0],n[0],i[1],n[1]),v=E(h,c,d,u),{x:f,y:m}=T(h,c,d,u);this.setScale({clientX:f,clientY:m},v>y?o:-o),this.redrawOnce()}this.oldClientX=[h,d],this.oldClientY=[c,u]}}}destroy(){var t;super.destroy(),(t=this.unBind)==null||t.call(this)}}class J extends K{getDefaultOverlayGroup(){var o,r,h,c,d;const e=this.layerGroups.get("默认图层群组");if(!e)return;const t=(o=e.getLayer("点位图层"))==null?void 0:o.getGroup("点位覆盖物群组"),s=(r=e.getLayer("线段图层"))==null?void 0:r.getGroup("线段覆盖物群组"),i=(h=e.getLayer("多边形图层"))==null?void 0:h.getGroup("多边形覆盖物群组"),n=(c=e.getLayer("文字图层"))==null?void 0:c.getGroup("文字覆盖物群组"),a=(d=e.getLayer("自定义绘制图层"))==null?void 0:d.getGroup("自定义绘制覆盖物群组");return{overlays_text:n,overlays_point:t,overlays_line:s,overlays_polygon:i,overlays_custom:a}}reset(){if(this.lockDragAndResize)return;this.isAuto=!0;const e=300,t={offset:{...this.offset},scale:this.scale-1};L(s=>{!this.isAuto||!this.canvas||this.lockDragAndResize||(s===1?(this.offset={x:0,y:0},this.scale=1,this.updateSize(),this.isAuto=!1):s>0&&(s=1-s,this.offset={x:t.offset.x*s,y:t.offset.y*s},this.scale=1+t.scale*s,this.updateSize()),this.redrawOnce(!0))},e)}zoom(e){const{canvas:t,rect:s}=this;if(!t||!s)return console.error("canvas is not HTMLCanvasElement");this.setScale("center",e),this.redrawOnce()}zoomIn(){this.zoom(this.delta)}zoomOut(){this.zoom(-this.delta)}setStyle(e){super.setStyle(e),this.redrawOnce()}setTheme(e){super.setTheme(e),this.redrawOnce()}setAxis(e){super.setAxis(e),this.redrawOnce()}setDefaultCenter(e){super.setDefaultCenter(e),this.redrawOnce()}toggleAxis(e){this.drawAxis.toggleAxis(e),this.redrawOnce()}togglePoint(e){const{overlays_point:t}=this.getDefaultOverlayGroup()||{};return t?(t.show.setShow(e??!t.show),this.redrawOnce(),t.show):!1}toggleLine(e){const{overlays_line:t}=this.getDefaultOverlayGroup()||{};return t?(t.show.setShow(e??!t.show),this.redrawOnce(),t.show):!1}togglePolygon(e){const{overlays_polygon:t}=this.getDefaultOverlayGroup()||{};return t?(t.show.setShow(e??!t.show),this.redrawOnce(),t.show):!1}toggleLock(e){return this.lockDragAndResize=e??!this.lockDragAndResize,this.lockDragAndResize}}class R extends J{constructor(e,t){if(super(e),this.drawAxis=new W(this),t){const{theme:s,axisConfig:i,axisShow:n,defaultCenter:a,offset:o}=t;s&&this.setTheme(s),i&&this.setAxis(i),n&&this.toggleAxis(n),a&&this.setDefaultCenter(a),o&&(this.offset.x=o.x||0,this.offset.y=o.y||0)}this.initLayerGroups(),this.updateCenter()}initLayerGroups(){const e=new O("多边形图层");e.addGroup(new D("多边形覆盖物群组")),e.setzIndex(1);const t=new O("线段图层");t.addGroup(new D("线段覆盖物群组")),t.setzIndex(2);const s=new O("点位图层");s.addGroup(new D("点位覆盖物群组")),s.setzIndex(3);const i=new O("文字图层");i.addGroup(new D("文字覆盖物群组")),i.setzIndex(4);const n=new O("自定义绘制图层");n.addGroup(new D("自定义绘制覆盖物群组")),n.setzIndex(5);const a=new k("默认图层群组");a.addLayer([i,s,t,e,n]),this.setLayerGroups(a)}gteLayerGroups(e){return this.layerGroups.get(e)}setLayerGroups(e){e instanceof k&&(this.layerGroups.set(e.name,e),e.setNotifyReload(()=>this.redrawOnce()),e.setMainCanvas(this))}removeLayerGroups(e){e instanceof k&&(this.layerGroups.delete(e.name),e.setNotifyReload(),e.setMainCanvas(),this.redrawOnce())}addLayer(e){const t=this.layerGroups.get("默认图层群组");t&&t.addLayer([e].flat())}removeLayer(e){const t=this.layerGroups.get("默认图层群组");t&&t.removeLayer([e].flat())}addOverlay(e){const{overlays_text:t,overlays_point:s,overlays_line:i,overlays_polygon:n,overlays_custom:a}=this.getDefaultOverlayGroup()||{};[e].flat().forEach(o=>{o instanceof S?t==null||t.addOverlays(o):o instanceof b?s==null||s.addOverlays(o):o instanceof I?i==null||i.addOverlays(o):o instanceof A?n==null||n.addOverlays(o):o instanceof V&&(a==null||a.addOverlays(o))})}removeOverlay(e){const{overlays_text:t,overlays_point:s,overlays_line:i,overlays_polygon:n,overlays_custom:a}=this.getDefaultOverlayGroup()||{};[e].flat().forEach(o=>{o instanceof S?t==null||t.removeOverlays(o):o instanceof b?s==null||s.removeOverlays(o):o instanceof I?i==null||i.removeOverlays(o):o instanceof A?n==null||n.removeOverlays(o):o instanceof V&&(a==null||a.addOverlays(o))})}destroy(){super.destroy()}}l(R,"LayerGroup",k),l(R,"Layer",O),l(R,"OverlayGroup",D),l(R,"Text",S),l(R,"Point",b),l(R,"Line",I),l(R,"Polygon",A),l(R,"Custom",V);export{x as D,R as _};
