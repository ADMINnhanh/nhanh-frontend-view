var Z=Object.defineProperty;var K=(p,e,a)=>e in p?Z(p,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):p[e]=a;var f=(p,e,a)=>K(p,typeof e!="symbol"?e+"":e,a);import{d as I,c as R,o as N,W as A,bg as Q,b5 as q,az as z,b as c,w as m,u as l,e as y,_ as H,ao as O,p as M,aw as tt,bh as et,at,bd as nt,bi as ot,A as G,Z as it,af as st,a1 as lt,t as P,as as k,B as E,a3 as U,bj as rt}from"./index-BxCq4Aag.js";import{R as ut}from"./ResponsiveDirectionLayout-DdxZIKW5.js";import{N as B}from"./InputGroupLabel-BcppEquF.js";import{N as $}from"./Select-DzUUZh3_.js";import{N as F}from"./InputGroup-nIlPyWxz.js";import{N as ct}from"./InputNumber-C0osJRuD.js";import{N as dt}from"./Slider-CNOJSZc4.js";import{N as ft}from"./ButtonGroup-zVh3Wump.js";import{N as ht,a as mt,b as pt}from"./Upload-B2Q-w7GX.js";import{A as vt}from"./Add-fpgf9Jae.js";import{C as gt}from"./CloudDownloadOutline-WSBpKLf_.js";import{N as W}from"./text-C25t0gju.js";import"./Suffix-va0eY4L_.js";import"./attribute-Cz32yFEB.js";import"./Empty-BlrWo4rT.js";import"./use-locale-WGPUknam.js";import"./Input-CTE8VoIJ.js";import"./Progress-DR1TTadG.js";import"./Image-mMuyvR02.js";import"./_createCompounder-B45JLg8s.js";const Ct={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},yt=A("path",{d:"M112 111v290c0 17.44 17 28.52 31 20.16l247.9-148.37c12.12-7.25 12.12-26.33 0-33.58L143 90.84c-14-8.36-31 2.72-31 20.16z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),xt=[yt],bt=I({name:"PlayOutline",render:function(e,a){return N(),R("svg",Ct,xt)}}),wt={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Dt=A("rect",{x:"96",y:"96",width:"320",height:"320",rx:"24",ry:"24",fill:"none",stroke:"currentColor","stroke-linejoin":"round","stroke-width":"32"},null,-1),Pt=[Dt],St=I({name:"StopOutline",render:function(e,a){return N(),R("svg",wt,Pt)}});var T=(p=>(p.LE="le",p.BE="be",p.LittleEndian="le",p.BigEndian="be",p))(T||{});const X=p=>p.toString().padStart(2,"0");function V(p){return`${X(Math.floor(p/60))}:${X((p%60).toFixed(0))}`}function Bt(p,e){const{options:a,name:o}=p,t=o.lastIndexOf("."),n=t>0?o.substring(t+1):"异常！",d=V(a.startTime||0);return{...a,name:o,currentTime:d,totalDuration:V(e),size:Q(p.file.size),type:n.toLocaleUpperCase()}}const Tt={class:"options-panel"},_t=I({__name:"options",props:{volume:{required:!0},volumeModifiers:{},options:{required:!0},optionsModifiers:{}},emits:["update:volume","update:options"],setup(p){const e=q(p,"volume"),a=q(p,"options");return(o,t)=>(N(),R("div",Tt,[z(o.$slots,"prefix",{},void 0,!0),c(l(F),null,{default:m(()=>[c(l(B),null,{default:m(()=>[...t[5]||(t[5]=[y("采样率",-1)])]),_:1}),c(l($),{value:a.value.sampleRate,"onUpdate:value":t[0]||(t[0]=n=>a.value.sampleRate=n),options:[8e3,16e3,22050,24e3,44100,48e3,96e3,192e3].map(n=>({label:String(n),value:n}))},null,8,["value","options"]),c(l(B),null,{default:m(()=>[...t[6]||(t[6]=[y("Hz",-1)])]),_:1})]),_:1}),c(l(F),null,{default:m(()=>[c(l(B),null,{default:m(()=>[...t[7]||(t[7]=[y("位深",-1)])]),_:1}),c(l($),{value:a.value.bitDepth,"onUpdate:value":t[1]||(t[1]=n=>a.value.bitDepth=n),options:[8,16,24,32].map(n=>({label:String(n),value:n}))},null,8,["value","options"]),c(l(B),null,{default:m(()=>[...t[8]||(t[8]=[y("bit",-1)])]),_:1})]),_:1}),c(l(F),null,{default:m(()=>[c(l(B),null,{default:m(()=>[...t[9]||(t[9]=[y("声道数",-1)])]),_:1}),c(l(ct),{value:a.value.channelCount,"onUpdate:value":t[2]||(t[2]=n=>a.value.channelCount=n),min:1,precision:0},null,8,["value"]),c(l(B),null,{default:m(()=>[...t[10]||(t[10]=[y("ch",-1)])]),_:1})]),_:1}),c(l(F),null,{default:m(()=>[c(l(B),null,{default:m(()=>[...t[11]||(t[11]=[y("字节序",-1)])]),_:1}),c(l($),{value:a.value.endianness,"onUpdate:value":t[3]||(t[3]=n=>a.value.endianness=n),options:[{label:"小端序",value:l(T).LE},{label:"大端序",value:l(T).BE}]},null,8,["value","options"])]),_:1}),c(l(F),null,{default:m(()=>[c(l(B),null,{default:m(()=>[...t[12]||(t[12]=[y("音量",-1)])]),_:1}),c(l(dt),{value:e.value,"onUpdate:value":t[4]||(t[4]=n=>e.value=n),min:0,max:1,step:.01},null,8,["value"])]),_:1}),z(o.$slots,"suffix",{},void 0,!0)]))}}),Mt=H(_t,[["__scopeId","data-v-2795bd02"]]),kt=["id"],At=I({__name:"HandleFileDrag",emits:["drop-callback"],setup(p,{emit:e}){const a=e,o=O("handle-file-drag-"),t=M(!1);function n(i){if(i.preventDefault(),i.stopPropagation(),!i.dataTransfer){t.value=!1;return}const u=i.dataTransfer.types;t.value=u.includes("Files")}function d(i){n(i)}function r(i){i.target.id==o&&(t.value=!1)}function s(i){var h;i.preventDefault(),i.stopPropagation(),t.value=!1;const u=(h=i.dataTransfer)==null?void 0:h.files;a("drop-callback",Array.from(u||[]))}return(i,u)=>{var h,x;return N(),R("div",{id:l(o),class:at(["handle-file-drag",t.value&&"file-drop-hint"]),style:tt({"--color":((x=(h=l(et).theme)==null?void 0:h.common)==null?void 0:x.successColor)||"#63e2b7"}),"drag-tip":"请将音频文件拖拽至此",onDragenter:n,onDragover:d,onDragleave:r,onDrop:s},[z(i.$slots,"default",{},void 0,!0)],46,kt)}}}),Nt=H(At,[["__scopeId","data-v-bf2639f9"]]);class Lt{constructor(){f(this,"config");f(this,"barWidth",2);f(this,"barGap",2);f(this,"barCount",0);f(this,"barColor","#2080f0");f(this,"amplitudeValues",[]);f(this,"amplitudeBarMetrics",[]);f(this,"lastTimelineX")}init(e){this.config=e,this.lastTimelineX=void 0,this.calculateAmplitudeData(),this.calculateAmplitudeBarMetrics(),this.render(0)}render(e){if(!this.config)return;const{canvasContext:a}=this.config,{amplitudeBarMetrics:o,barColor:t,barWidth:n}=this,{width:d,height:r}=a.canvas,s=Math.floor((d-2)*e/100);this.lastTimelineX!=s&&(this.lastTimelineX=s,a.clearRect(0,0,d,r),a.fillStyle=t,o.forEach(({x:i,y:u,height:h})=>{s<=i&&(a.fillStyle="#B1B1B1FF"),a.fillRect(i,u,n,h)}),a.fillStyle=t,a.fillRect(s,0,2,r))}calculateAmplitudeData(){if(!this.config)return;const{canvasContext:e,audioBuffer:a,channelCount:o}=this.config,{barWidth:t,barGap:n}=this;this.barCount=Math.ceil(e.canvas.width/(t+n));const d=a.length,r=Array.from({length:o},(i,u)=>a.getChannelData(u)),s=Math.floor(d/this.barCount);this.amplitudeValues=[];for(let i=0;i<this.barCount;i++){const u=i*s,h=r.reduce((x,w)=>{const _=w.slice(u,u+s).reduce((L,g)=>L+g**2,0),D=Math.sqrt(_/s);return Math.max(x,D)},0);this.amplitudeValues.push(h)}}calculateAmplitudeBarMetrics(){var i;const e=(i=this.config)==null?void 0:i.canvasContext.canvas;if(!e)return;const{barWidth:a,barGap:o,barCount:t,amplitudeValues:n}=this,d=e.height,r=e.height/2;let s=0;this.amplitudeBarMetrics=[];for(let u=0;u<t;u++){const h=d*n[u];this.amplitudeBarMetrics.push({x:s,y:r-h/2,height:h}),s+=a+o}}clear(){this.amplitudeValues=[],this.amplitudeBarMetrics=[]}}class Ft{constructor(){f(this,"config");f(this,"channelColors",["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc"]);f(this,"channelRenderHeight",0);f(this,"waveformDataLength",0);f(this,"channelAmplitudeData",[]);f(this,"lastRenderedStartIndex")}init(e){this.config=e,this.lastRenderedStartIndex=void 0,this.channelRenderHeight=Math.floor(e.canvasContext.canvas.height/e.channelCount),this.preprocessAudioData(),this.renderChannelBaseLines()}renderChannelBaseLines(){const{config:e,channelColors:a,channelRenderHeight:o}=this;if(!e)return;const{channelCount:t,canvasContext:n}=e,{width:d}=n.canvas;n.clearRect(0,0,d,n.canvas.height);for(let r=0;r<t;r++){const s=a[r%a.length];n.fillStyle=s;const i=r*o+o/2;n.fillRect(0,i,d,1)}}render(e){const{waveformDataLength:a,channelRenderHeight:o,channelAmplitudeData:t,config:n,channelColors:d}=this;if(!n||!t.length)return;const{channelCount:r,canvasContext:s}=n,{width:i,height:u}=s.canvas,h=Math.floor((a-i)*e/100);if(this.lastRenderedStartIndex!==h){this.lastRenderedStartIndex=h,s.clearRect(0,0,i,u);for(let x=0;x<r;x++){const w=d[x%d.length];s.fillStyle=w;const _=o*x+o/2;for(let D=0;D<i;D++){const L=t[x][D+h]||0,g=Math.floor(_-o/2*L);s.fillRect(D,g,1,1)}}}}preprocessAudioData(){if(!this.config)return;const{canvasContext:e,audioBuffer:a,channelCount:o,fps:t,duration:n}=this.config,d=Math.floor(n*t);this.waveformDataLength=Math.min(a.length,e.canvas.width*d);const r=Math.floor(a.length/this.waveformDataLength);this.channelAmplitudeData=Array.from({length:o}).map(()=>new Float32Array(this.waveformDataLength));for(let s=0;s<o;s++){const i=a.getChannelData(s);for(let u=0;u<this.waveformDataLength;u++){const h=u*r,w=i.slice(h,h+r).reduce((_,D)=>_+D,0)/r;this.channelAmplitudeData[s][u]=w}}}clear(){this.channelAmplitudeData=[]}}class It{constructor(){f(this,"audioContext");f(this,"isPlaying",!1);f(this,"source");f(this,"audioBuffer");f(this,"gainNode");f(this,"currentVolume",1);f(this,"startTime",0);f(this,"duration",0);f(this,"playStartTime",0);f(this,"offsetTime");f(this,"options",{sampleRate:16e3,channelCount:1,bitDepth:16,startTime:0,duration:0,endianness:T.LE,volume:1});f(this,"onPlayCompleted");f(this,"playProgressCallback")}get totalDuration(){return this.audioBuffer?this.audioBuffer.duration:0}get ready(){return!!this.audioContext}setVolume(e){if(!this.gainNode){console.warn("增益节点未初始化，请先调用 init()");return}const a=Math.max(0,Math.min(1,e));this.currentVolume=a,this.gainNode.gain.value=a}init(){if(!this.audioContext){const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.currentVolume}}async initPCM(e,a={}){if(this.init(),!this.audioContext){console.error("音频上下文初始化失败");return}Object.assign(this.options,a);const{sampleRate:o,channelCount:t,bitDepth:n,startTime:d,duration:r,endianness:s,volume:i}=this.options;this.startTime=d,this.duration=r,this.offsetTime=void 0,this.setVolume(i),this.stop();try{const u=this.convertPCMToFloat32(e,n,s);this.audioBuffer=this.audioContext.createBuffer(t,u.length/t,o);for(let h=0;h<t;h++){const x=this.audioBuffer.getChannelData(h);for(let w=0;w<x.length;w++)x[w]=u[w*t+h]}}catch(u){console.error("播放 PCM 失败：",u)}}convertPCMToFloat32(e,a,o=T.LE){const t=new DataView(e),n=a/8,d=o===T.LE,r=Math.floor(e.byteLength/n),s=new Float32Array(r);for(let i=0;i<r;i++){const u=i*n;switch(a){case 8:s[i]=(t.getUint8(u)-128)/128;break;case 16:s[i]=t.getInt16(u,d)/32768;break;case 24:let h;d?h=t.getUint8(u)|t.getUint8(u+1)<<8|t.getUint8(u+2)<<16:h=t.getUint8(u)<<16|t.getUint8(u+1)<<8|t.getUint8(u+2),h&8388608&&(h|=4278190080),s[i]=h/8388608;break;case 32:s[i]=t.getInt32(u,d)/2147483648;break}}return s}playFromPosition(e=0,a=0){if(!this.audioBuffer||!this.audioContext){console.error("请先加载 PCM 数据");return}this.isPlaying&&this.stop();const o=this.audioBuffer.duration,t=Math.max(0,Math.min(e,o)),n=a>0?Math.min(a,o-t):void 0;this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.gainNode),this.source.start(0,t,n),this.isPlaying=!0,this.playStartTime=this.audioContext.currentTime,this.source.onended=()=>{var d,r;console.log("onended"),this.isPlaying=!1,typeof this.offsetTime=="number"&&(this.offsetTime+=(((d=this.audioContext)==null?void 0:d.currentTime)||0)-this.playStartTime),(r=this.onPlayCompleted)==null||r.call(this)}}updatePlayProgress(){const{isPlaying:e,audioContext:a,audioBuffer:o,offsetTime:t,playStartTime:n,playProgressCallback:d}=this;if(!e||!a||!o||!d)return;const r=(t||0)+(a.currentTime-n),s=r/o.duration*100,i=r.toFixed(2),u=o.duration.toFixed(2),h=s.toFixed(1);d(i,u,h),requestAnimationFrame(()=>this.updatePlayProgress())}async play(e){if(typeof e=="number")this.stop(),await nt(()=>!this.isPlaying,500),this.offsetTime=e;else{if(this.isPlaying)return;const{startTime:a,offsetTime:o}=this;(!o||o+a>=this.totalDuration)&&(this.offsetTime=0)}this.playFromPosition(this.startTime+this.offsetTime,this.duration),this.updatePlayProgress()}stop(){if(this.source){try{this.source.stop()}catch{}this.source.disconnect(),this.source=void 0}}clear(){this.stop(),this.isPlaying=!1,this.audioBuffer=void 0}}let Y=60;ot(p=>Y=p,60);class Rt{constructor(){f(this,"audioSpectrum",new Lt);f(this,"audioSpectrumCanvas",document.createElement("canvas"));f(this,"audioSpectrumCtx",this.audioSpectrumCanvas.getContext("2d"));f(this,"audioWaveform",new Ft);f(this,"audioWaveformCanvas",document.createElement("canvas"));f(this,"audioWaveformCtx",this.audioWaveformCanvas.getContext("2d"));f(this,"audioPlayer",new It);f(this,"canvas");f(this,"ctx");f(this,"onPlayCompleted");f(this,"playProgressCallback");this.audioPlayer.onPlayCompleted=()=>{var e;(e=this.onPlayCompleted)==null||e.call(this)},this.audioPlayer.playProgressCallback=(e,a,o)=>{var n;const t=Number(o);this.render(t),(n=this.playProgressCallback)==null||n.call(this,e,a,o)}}get totalDuration(){return this.audioPlayer.totalDuration}init(e){this.initPCM(e),this.audioPlayer.ready&&this.initCanvas(e)}initPCM(e){const{audioPlayer:a}=this,{pcmData:o,pcmOptions:t}=e;a.initPCM(o,t)}initCanvas(e){const{audioPlayer:a,audioSpectrumCanvas:o,audioSpectrumCtx:t,audioWaveformCanvas:n,audioWaveformCtx:d}=this,{canvas:r}=e,s=a.options.channelCount,i=a.audioBuffer,u=a.totalDuration,h=Math.floor(r.getBoundingClientRect().width);if(r.width=h,r.height=100*(s+1),this.canvas=r,this.ctx=r.getContext("2d"),!this.ctx||!t||!d){console.error("Canvas 上下文不可用。");return}o.width=h,o.height=100,n.width=h,n.height=100*s;const x={channelCount:s,audioBuffer:i,duration:u,fps:Y};this.audioWaveform.init({...x,canvasContext:d}),this.audioSpectrum.init({...x,canvasContext:t}),this.ctx.drawImage(n,0,0),this.ctx.drawImage(o,0,n.height)}render(e){const{canvas:a,ctx:o,audioSpectrum:t,audioSpectrumCanvas:n,audioWaveform:d,audioWaveformCanvas:r}=this;if(!a||!o){console.error("Canvas 不可用。");return}o.clearRect(0,0,a.width,a.height),t.render(e),d.render(e),o.drawImage(r,0,0),o.drawImage(n,0,r.height)}setVolume(e){this.audioPlayer.setVolume(e)}play(e){return this.audioPlayer.play(e)}stop(){this.audioPlayer.stop()}clear(){this.audioPlayer.clear(),this.audioSpectrum.clear(),this.audioWaveform.clear();const{ctx:e,canvas:a}=this;e&&a&&e.clearRect(0,0,a.width,a.height)}}const Vt={key:0,class:"audio-player-container"},Et={class:"canvas-container"},Ut=["id"],$t={class:"time-container"},j=".mp3,.pcm,.wav",Wt=I({__name:"index",setup(p){const e=O("audio-player-"),a=O("file-list-"),o=M(!1),t=M(void 0),n=M([]),d=M(.5),r=M({sampleRate:16e3,bitDepth:16,channelCount:1,startTime:0,duration:0,endianness:T.LE}),s=M(),i=new Rt;i.onPlayCompleted=()=>{o.value=!1},i.playProgressCallback=g=>{s.value.currentTime=V(Number(g))},G([r,t],async([g,v])=>{if(typeof v=="number"){const C=n.value[v],b=await C.file.arrayBuffer();s.value=Bt(C,0),requestAnimationFrame(()=>{const S=document.getElementById(e);i.init({canvas:S,pcmData:b,pcmOptions:g}),s.value.totalDuration=V(Number(i.totalDuration))})}},{deep:!0}),G(d,g=>{i.setVolume(g)});function u(){i.play(),o.value=!0}function h(){i.stop(),o.value=!1}async function x(g){const{offsetX:v,target:C}=g,b=C.clientWidth,S=v/b*i.totalDuration;await i.play(S),o.value=!0}function w(g){const v=b=>j.split(",").some(S=>b.endsWith(S)),C=g.filter(b=>v(b.name));C.length>0?C.forEach(b=>{n.value.push({id:String(b.lastModified),name:b.name,status:"pending",file:b,options:{}})}):window.$message.warning("请拖拽音频文件")}function _(){rt.get("./multimedia/Jay Chou.pcm",{responseType:"blob"}).then(g=>{const v=new File([g.data],"Jay Chou.pcm");n.value.push({id:String(v.lastModified),name:v.name,status:"finished",file:v,options:{sampleRate:24e3,bitDepth:16,channelCount:2,endianness:T.LE}}),D(n.value.length-1)})}function D(g){t.value=g,Object.assign(r.value,n.value[g].options),setTimeout(()=>{document.querySelectorAll(`#${a} .n-upload-file`).forEach((C,b)=>{C.classList.remove("active"),b==g&&C.classList.add("active")})},100)}function L(g){const v=g.target.closest(".n-button"),C=g.target.closest(".n-upload-file");if(!C)return;const b=document.querySelectorAll(`#${a} .n-upload-file`),S=Array.from(b).findIndex(J=>J===C);if(v){S==t.value&&(t.value=void 0,o.value=!1,i.clear());return}S!=-1&&D(S)}return(g,v)=>(N(),it(Nt,{onDropCallback:w},{default:m(()=>[c(ut,{"default-size":.35,min:0},{left:m(()=>[c(Mt,{options:r.value,"onUpdate:options":v[2]||(v[2]=C=>r.value=C),volume:d.value,"onUpdate:volume":v[3]||(v[3]=C=>d.value=C)},{prefix:m(()=>[c(l(ht),{"file-list":n.value,"onUpdate:fileList":v[0]||(v[0]=C=>n.value=C),abstract:"",accept:j,multiple:""},{default:m(()=>[c(l(ft),null,{default:m(()=>[c(l(mt),{abstract:""},{default:m(({handleClick:C})=>[c(l(E),{type:"info",onClick:C},{icon:m(()=>[c(l(U),{component:l(vt)},null,8,["component"])]),default:m(()=>[v[4]||(v[4]=y(" 选择或拖入文件 ",-1))]),_:1},8,["onClick"])]),_:1}),c(l(E),{type:"info",ghost:"",onClick:_},{icon:m(()=>[c(l(U),{component:l(gt)},null,8,["component"])]),default:m(()=>[v[5]||(v[5]=y(" 加载样例 ",-1))]),_:1})]),_:1}),c(l(pt),{id:l(a),onClick:L},null,8,["id"])]),_:1},8,["file-list"])]),suffix:m(()=>[c(l(E),{disabled:typeof t.value!="number",type:o.value?"error":"success",ghost:"",onClick:v[1]||(v[1]=C=>o.value?h():u())},{icon:m(()=>[c(l(U),{component:o.value?l(St):l(bt)},null,8,["component"])]),default:m(()=>[y(" "+P(o.value?"暂停":"播放"),1)]),_:1},8,["disabled","type"])]),_:1},8,["options","volume"])]),right:m(()=>[s.value?(N(),R("div",Vt,[c(l(lt),null,{default:m(()=>[c(l(W),null,{default:m(()=>[y(P(s.value.name),1)]),_:1}),c(l(k),{type:"info"},{default:m(()=>[y(P(s.value.type),1)]),_:1}),c(l(k),{color:{color:"#8a2be21a",textColor:"#9339E7FF",borderColor:"#9339E7FF"}},{default:m(()=>[y(P(s.value.size),1)]),_:1}),c(l(k),{type:"success"},{default:m(()=>[y(P(s.value.totalDuration),1)]),_:1}),c(l(k),{type:"warning"},{default:m(()=>[y(P(s.value.sampleRate)+"Hz ",1)]),_:1}),c(l(k),null,{default:m(()=>[y(P(s.value.channelCount)+"ch ",1)]),_:1}),c(l(k),null,{default:m(()=>[y(P(s.value.bitDepth)+"bit ",1)]),_:1})]),_:1}),A("div",Et,[A("canvas",{id:l(e)},null,8,Ut),A("div",{class:"progress",onClick:x})]),A("div",$t,[c(l(W),null,{default:m(()=>[y(P(s.value.currentTime),1)]),_:1}),c(l(W),null,{default:m(()=>[y(P(s.value.totalDuration),1)]),_:1})])])):st("",!0)]),_:1})]),_:1}))}}),ue=H(Wt,[["__scopeId","data-v-dec0eaa8"]]);export{ue as default};
