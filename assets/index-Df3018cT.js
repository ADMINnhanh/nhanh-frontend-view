var Z=Object.defineProperty;var K=(p,a,e)=>a in p?Z(p,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):p[a]=e;var h=(p,a,e)=>K(p,typeof a!="symbol"?a+"":a,e);import{d as N,c as I,o as M,W as F,b5 as G,az as W,b as d,w as f,u as l,e as x,_ as q,ao as z,p as _,aw as Q,bg as tt,at as et,bh as at,bi as nt,A as R,Z as ot,af as it,a1 as st,t as D,as as T,B as V,a3 as U,bj as lt}from"./index-C2qVew70.js";import{R as rt}from"./ResponsiveDirectionLayout-DS8C8U7C.js";import{N as B}from"./InputGroupLabel-BFjB7v6X.js";import{N as $}from"./Select-BWT-jw4e.js";import{N as k}from"./InputGroup-BGGX-evU.js";import{N as ut}from"./InputNumber-B10hPADD.js";import{N as ct}from"./Slider-BeteAIbn.js";import{N as dt}from"./ButtonGroup-D67oCIzg.js";import{N as ft,a as ht,b as mt}from"./Upload-Ce5Lz5Sb.js";import{A as pt}from"./Add-0G1g0gb8.js";import{C as vt}from"./CloudDownloadOutline-bhoHM_9w.js";import{N as E}from"./text-B-lqjxw7.js";import"./Suffix-Yjzg76zV.js";import"./attribute-Cz32yFEB.js";import"./Empty-BzDSsPdn.js";import"./use-locale-CHEZPlu-.js";import"./Input-BJZkQq_O.js";import"./Progress-CVP3b71p.js";import"./Image-DvCNZjuR.js";import"./_createCompounder-Ciclf1fr.js";const gt={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Ct=F("path",{d:"M112 111v290c0 17.44 17 28.52 31 20.16l247.9-148.37c12.12-7.25 12.12-26.33 0-33.58L143 90.84c-14-8.36-31 2.72-31 20.16z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),xt=[Ct],yt=N({name:"PlayOutline",render:function(a,e){return M(),I("svg",gt,xt)}}),bt={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},wt=F("rect",{x:"96",y:"96",width:"320",height:"320",rx:"24",ry:"24",fill:"none",stroke:"currentColor","stroke-linejoin":"round","stroke-width":"32"},null,-1),Dt=[wt],Bt=N({name:"StopOutline",render:function(a,e){return M(),I("svg",bt,Dt)}});var A=(p=>(p.LE="le",p.BE="be",p.LittleEndian="le",p.BigEndian="be",p))(A||{});class St{constructor(){h(this,"audioContext");h(this,"isPlaying",!1);h(this,"source");h(this,"audioBuffer");h(this,"gainNode");h(this,"currentVolume",1);h(this,"startTime",0);h(this,"duration",0);h(this,"playStartTime",0);h(this,"offsetTime",0);h(this,"onPlayCompleted");h(this,"playProgressCallback")}get totalDuration(){return this.audioBuffer?this.audioBuffer.duration:0}init(){if(!this.audioContext){const a=window.AudioContext||window.webkitAudioContext;this.audioContext=new a,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.currentVolume}}setVolume(a){if(!this.gainNode){console.warn("增益节点未初始化，请先调用 init() 或 playPCM()");return}const e=Math.max(0,Math.min(1,a));this.currentVolume=e,this.gainNode.gain.value=e}async initPCM(a,e={}){if(this.init(),!this.audioContext){console.error("音频上下文初始化失败");return}const{sampleRate:i=16e3,channelCount:t=1,bitDepth:n=16,startTime:u=0,duration:c=0,endianness:s="le",volume:o=1}=e;this.startTime=u,this.duration=c,this.offsetTime=0,this.setVolume(o),this.stop();try{const r=this.convertPCMToFloat32(a,n,s);this.audioBuffer=this.audioContext.createBuffer(t,r.length/t,i);for(let m=0;m<t;m++){const y=this.audioBuffer.getChannelData(m);for(let w=0;w<y.length;w++)y[w]=r[w*t+m]}}catch(r){console.error("播放 PCM 失败：",r)}}async playPCM(a,e){if(a)this.initPCM(a,e);else if(!this.audioBuffer){console.error("请传入 PCM 音频数据");return}this.audioContext&&(this.offsetTime=0,this.play())}playFromPosition(a=0,e=0){if(!this.audioBuffer||!this.audioContext){console.error("请先加载 PCM 数据");return}this.isPlaying&&this.stop();const i=this.audioBuffer.duration,t=Math.max(0,Math.min(a,i)),n=e>0?Math.min(e,i-t):void 0;this.source=this.audioContext.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.connect(this.gainNode),this.source.start(0,t,n),this.isPlaying=!0,this.playStartTime=this.audioContext.currentTime,this.source.onended=()=>{var u,c;this.isPlaying&&(this.isPlaying=!1,this.offsetTime+=(((u=this.audioContext)==null?void 0:u.currentTime)||0)-this.playStartTime),(c=this.onPlayCompleted)==null||c.call(this)}}convertPCMToFloat32(a,e,i="le"){const t=new DataView(a),n=e/8,u=i==="le",c=Math.floor(a.byteLength/n),s=new Float32Array(c);for(let o=0;o<c;o++){const r=o*n;switch(e){case 8:s[o]=(t.getUint8(r)-128)/128;break;case 16:s[o]=t.getInt16(r,u)/32768;break;case 24:let m;u?m=t.getUint8(r)|t.getUint8(r+1)<<8|t.getUint8(r+2)<<16:m=t.getUint8(r)<<16|t.getUint8(r+1)<<8|t.getUint8(r+2),m&8388608&&(m|=4278190080),s[o]=m/8388608;break;case 32:s[o]=t.getInt32(r,u)/2147483648;break}}return s}updatePlayProgress(){const{isPlaying:a,audioContext:e,audioBuffer:i,offsetTime:t,playStartTime:n,playProgressCallback:u}=this;if(!a||!e||!i||!u)return;const c=t+(e.currentTime-n),s=c/i.duration*100,o=c.toFixed(2),r=i.duration.toFixed(2),m=s.toFixed(1);u(o,r,m),requestAnimationFrame(()=>this.updatePlayProgress())}play(){if(!this.isPlaying){const{startTime:a,duration:e,offsetTime:i}=this;i+a>=this.totalDuration&&(this.offsetTime=0),this.playFromPosition(a+this.offsetTime,e),this.updatePlayProgress()}}stop(){if(this.source){try{this.source.stop()}catch{}this.source.disconnect(),this.source=void 0,this.isPlaying=!1}}clear(){this.stop(),this.isPlaying=!1,this.audioBuffer=void 0}}const Pt={class:"options-panel"},_t=N({__name:"options",props:{volume:{required:!0},volumeModifiers:{},options:{required:!0},optionsModifiers:{}},emits:["update:volume","update:options"],setup(p){const a=G(p,"volume"),e=G(p,"options");return(i,t)=>(M(),I("div",Pt,[W(i.$slots,"prefix",{},void 0,!0),d(l(k),null,{default:f(()=>[d(l(B),null,{default:f(()=>[...t[5]||(t[5]=[x("采样率",-1)])]),_:1}),d(l($),{value:e.value.sampleRate,"onUpdate:value":t[0]||(t[0]=n=>e.value.sampleRate=n),options:[8e3,16e3,22050,24e3,44100,48e3,96e3,192e3].map(n=>({label:String(n),value:n}))},null,8,["value","options"]),d(l(B),null,{default:f(()=>[...t[6]||(t[6]=[x("Hz",-1)])]),_:1})]),_:1}),d(l(k),null,{default:f(()=>[d(l(B),null,{default:f(()=>[...t[7]||(t[7]=[x("位深",-1)])]),_:1}),d(l($),{value:e.value.bitDepth,"onUpdate:value":t[1]||(t[1]=n=>e.value.bitDepth=n),options:[8,16,24,32].map(n=>({label:String(n),value:n}))},null,8,["value","options"]),d(l(B),null,{default:f(()=>[...t[8]||(t[8]=[x("bit",-1)])]),_:1})]),_:1}),d(l(k),null,{default:f(()=>[d(l(B),null,{default:f(()=>[...t[9]||(t[9]=[x("声道数",-1)])]),_:1}),d(l(ut),{value:e.value.channelCount,"onUpdate:value":t[2]||(t[2]=n=>e.value.channelCount=n),min:1,precision:0},null,8,["value"]),d(l(B),null,{default:f(()=>[...t[10]||(t[10]=[x("ch",-1)])]),_:1})]),_:1}),d(l(k),null,{default:f(()=>[d(l(B),null,{default:f(()=>[...t[11]||(t[11]=[x("字节序",-1)])]),_:1}),d(l($),{value:e.value.endianness,"onUpdate:value":t[3]||(t[3]=n=>e.value.endianness=n),options:[{label:"小端序",value:l(A).LE},{label:"大端序",value:l(A).BE}]},null,8,["value","options"])]),_:1}),d(l(k),null,{default:f(()=>[d(l(B),null,{default:f(()=>[...t[12]||(t[12]=[x("音量",-1)])]),_:1}),d(l(ct),{value:a.value,"onUpdate:value":t[4]||(t[4]=n=>a.value=n),min:0,max:1,step:.01},null,8,["value"])]),_:1}),W(i.$slots,"suffix",{},void 0,!0)]))}}),Tt=q(_t,[["__scopeId","data-v-3e592fae"]]),Mt=["id"],kt=N({__name:"HandleFileDrag",emits:["drop-callback"],setup(p,{emit:a}){const e=a,i=z("handle-file-drag-"),t=_(!1);function n(o){if(o.preventDefault(),o.stopPropagation(),!o.dataTransfer){t.value=!1;return}const r=o.dataTransfer.types;t.value=r.includes("Files")}function u(o){n(o)}function c(o){o.target.id==i&&(t.value=!1)}function s(o){var m;o.preventDefault(),o.stopPropagation(),t.value=!1;const r=(m=o.dataTransfer)==null?void 0:m.files;e("drop-callback",Array.from(r||[]))}return(o,r)=>{var m,y;return M(),I("div",{id:l(i),class:et(["handle-file-drag",t.value&&"file-drop-hint"]),style:Q({"--color":((y=(m=l(tt).theme)==null?void 0:m.common)==null?void 0:y.successColor)||"#63e2b7"}),"drag-tip":"请将音频文件拖拽至此",onDragenter:n,onDragover:u,onDragleave:c,onDrop:s},[W(o.$slots,"default",{},void 0,!0)],46,Mt)}}}),At=q(kt,[["__scopeId","data-v-bf2639f9"]]),X=p=>p.toString().padStart(2,"0");function O(p){return`${X(Math.floor(p/60))}:${X((p%60).toFixed(0))}`}function Nt(p,a){const{options:e,name:i}=p,t=i.lastIndexOf("."),n=t>0?i.substring(t+1):"异常！",u=O(e.startTime||0);return{...e,name:i,currentTime:u,totalDuration:O(a),size:at(p.file.size),type:n.toLocaleUpperCase()}}class It{constructor(){h(this,"config");h(this,"barWidth",2);h(this,"barGap",2);h(this,"barCount",0);h(this,"barColor","#2080f0");h(this,"amplitudeValues",[]);h(this,"amplitudeBarMetrics",[]);h(this,"lastTimelineX")}init(a){this.config=a,this.lastTimelineX=void 0,this.calculateAmplitudeData(),this.calculateAmplitudeBarMetrics(),this.render(0)}render(a){if(!this.config)return;const{canvasContext:e}=this.config,{amplitudeBarMetrics:i,barColor:t,barWidth:n}=this,{width:u,height:c}=e.canvas,s=Math.floor(u*a/100);this.lastTimelineX!=s&&(this.lastTimelineX=s,e.clearRect(0,0,u,c),e.fillStyle=t,i.forEach(({x:o,y:r,height:m})=>{s<=o&&(e.fillStyle="#B1B1B1FF"),e.fillRect(o,r,n,m)}),e.fillStyle=t,e.fillRect(s,0,2,c))}calculateAmplitudeData(){if(!this.config)return;const{canvasContext:a,audioBuffer:e,channelCount:i}=this.config,{barWidth:t,barGap:n}=this;this.barCount=Math.ceil(a.canvas.width/(t+n));const u=e.length,c=Array.from({length:i},(o,r)=>e.getChannelData(r)),s=Math.floor(u/this.barCount);this.amplitudeValues=[];for(let o=0;o<this.barCount;o++){const r=o*s,m=c.reduce((y,w)=>{const S=w.slice(r,r+s).reduce((g,C)=>g+C**2,0),v=Math.sqrt(S/s);return Math.max(y,v)},0);this.amplitudeValues.push(m)}}calculateAmplitudeBarMetrics(){var o;const a=(o=this.config)==null?void 0:o.canvasContext.canvas;if(!a)return;const{barWidth:e,barGap:i,barCount:t,amplitudeValues:n}=this,u=a.height,c=a.height/2;let s=0;this.amplitudeBarMetrics=[];for(let r=0;r<t;r++){const m=u*n[r];this.amplitudeBarMetrics.push({x:s,y:c-m/2,height:m}),s+=e+i}}}class Ft{constructor(){h(this,"config");h(this,"channelColors",["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc"]);h(this,"channelRenderHeight",0);h(this,"waveformDataLength",0);h(this,"channelAmplitudeData",[]);h(this,"lastRenderedStartIndex")}init(a){this.config=a,this.lastRenderedStartIndex=void 0,this.channelRenderHeight=Math.floor(a.canvasContext.canvas.height/a.channelCount),this.preprocessAudioData(),this.renderChannelBaseLines()}renderChannelBaseLines(){const{config:a,channelColors:e,channelRenderHeight:i}=this;if(!a)return;const{channelCount:t,canvasContext:n}=a,{width:u}=n.canvas;n.clearRect(0,0,u,n.canvas.height);for(let c=0;c<t;c++){const s=e[c%e.length];n.fillStyle=s;const o=c*i+i/2;n.fillRect(0,o,u,1)}}render(a){const{waveformDataLength:e,channelRenderHeight:i,channelAmplitudeData:t,config:n,channelColors:u}=this;if(!n||!t.length)return;const{channelCount:c,canvasContext:s}=n,{width:o,height:r}=s.canvas,m=Math.floor((e-o)*a/100);if(this.lastRenderedStartIndex!==m){this.lastRenderedStartIndex=m,s.clearRect(0,0,o,r);for(let y=0;y<c;y++){const w=u[y%u.length];s.fillStyle=w;const S=i*y+i/2;for(let v=0;v<o;v++){const g=t[y][v+m]||0,C=Math.floor(S-i/2*g);s.fillRect(v,C,1,1)}}}}preprocessAudioData(){if(!this.config)return;const{canvasContext:a,audioBuffer:e,channelCount:i,fps:t,duration:n}=this.config,u=Math.floor(n*t);this.waveformDataLength=Math.min(e.length,a.canvas.width*u);const c=Math.floor(e.length/this.waveformDataLength);this.channelAmplitudeData=Array.from({length:i}).map(()=>new Float32Array(this.waveformDataLength));for(let s=0;s<i;s++){const o=e.getChannelData(s);for(let r=0;r<this.waveformDataLength;r++){const m=r*c,w=o.slice(m,m+c).reduce((S,v)=>S+v,0)/c;this.channelAmplitudeData[s][r]=w}}}}let H=60;nt(p=>H=p,60);class Lt{constructor(){h(this,"audioSpectrum",new It);h(this,"audioSpectrumCanvas",document.createElement("canvas"));h(this,"audioSpectrumCtx",this.audioSpectrumCanvas.getContext("2d"));h(this,"audioWaveform",new Ft);h(this,"audioWaveformCanvas",document.createElement("canvas"));h(this,"audioWaveformCtx",this.audioWaveformCanvas.getContext("2d"));h(this,"canvas");h(this,"ctx")}init(a){const{audioSpectrumCanvas:e,audioSpectrumCtx:i,audioWaveformCanvas:t,audioWaveformCtx:n}=this,{canvas:u,channelCount:c}=a,s=Math.floor(u.getBoundingClientRect().width);if(u.width=s,u.height=100*(c+1),this.canvas=u,this.ctx=u.getContext("2d"),!this.ctx||!i||!n){console.error("Canvas 上下文不可用。");return}e.width=s,e.height=100,t.width=s,t.height=100*c,this.audioWaveform.init({...a,fps:H,canvasContext:n}),this.audioSpectrum.init({...a,fps:H,canvasContext:i}),this.ctx.drawImage(t,0,0),this.ctx.drawImage(e,0,t.height)}render(a){const{canvas:e,ctx:i,audioSpectrum:t,audioSpectrumCanvas:n,audioWaveform:u,audioWaveformCanvas:c}=this;if(!e||!i){console.error("Canvas 不可用。");return}i.clearRect(0,0,e.width,e.height),t.render(a),u.render(a),i.drawImage(c,0,0),i.drawImage(n,0,c.height)}}const Rt={key:0,class:"audio-player-container"},Vt=["id"],Ut={class:"time-container"},Y=".mp3,.pcm,.wav",$t=N({__name:"index",setup(p){const a=z("audio-player-"),e=z("file-list-"),i=_(!1),t=_(void 0),n=_([]),u=_(.5),c=_({sampleRate:16e3,bitDepth:16,channelCount:1,startTime:0,duration:0,endianness:A.LE}),s=_(),o=new St,r=new Lt;o.onPlayCompleted=()=>{i.value=!1},o.playProgressCallback=(v,g,C)=>{const b=Number(C);r.render(b),s.value.currentTime=O(Number(v))},R([c,t],async([v,g])=>{if(typeof g=="number"){const C=n.value[g],b=await C.file.arrayBuffer();o.initPCM(b,v),s.value=Nt(C,o.totalDuration),requestAnimationFrame(()=>{const P=document.getElementById(a),L=o.audioBuffer,j=o.totalDuration,J=v.channelCount;r.init({canvas:P,audioBuffer:L,channelCount:J,duration:j})})}},{deep:!0}),R(u,v=>{o.setVolume(v)}),R(i,v=>{v?o.play():o.stop()});function m(v){const g=b=>Y.split(",").some(P=>b.endsWith(P)),C=v.filter(b=>g(b.name));C.length>0?C.forEach(b=>{n.value.push({id:String(b.lastModified),name:b.name,status:"pending",file:b,options:{}})}):window.$message.warning("请拖拽音频文件")}function y(){lt.get("./multimedia/Jay Chou.pcm",{responseType:"blob"}).then(v=>{const g=new File([v.data],"Jay Chou.pcm");n.value.push({id:String(g.lastModified),name:g.name,status:"finished",file:g,options:{sampleRate:24e3,bitDepth:16,channelCount:2,endianness:A.LE}}),w(n.value.length-1)})}function w(v){t.value=v,Object.assign(c.value,n.value[v].options),setTimeout(()=>{document.querySelectorAll(`#${e} .n-upload-file`).forEach((C,b)=>{C.classList.remove("active"),b==v&&C.classList.add("active")})},100)}function S(v){const g=v.target.closest(".n-button"),C=v.target.closest(".n-upload-file");if(!C)return;const b=document.querySelectorAll(`#${e} .n-upload-file`),P=Array.from(b).findIndex(L=>L===C);if(g){P==t.value&&(t.value=void 0,i.value=!1,o.clear());return}P!=-1&&w(P)}return(v,g)=>(M(),ot(At,{onDropCallback:m},{default:f(()=>[d(rt,{"default-size":.35,min:0},{left:f(()=>[d(Tt,{options:c.value,"onUpdate:options":g[2]||(g[2]=C=>c.value=C),volume:u.value,"onUpdate:volume":g[3]||(g[3]=C=>u.value=C)},{prefix:f(()=>[d(l(ft),{"file-list":n.value,"onUpdate:fileList":g[0]||(g[0]=C=>n.value=C),abstract:"",accept:Y,multiple:""},{default:f(()=>[d(l(dt),null,{default:f(()=>[d(l(ht),{abstract:""},{default:f(({handleClick:C})=>[d(l(V),{type:"info",onClick:C},{icon:f(()=>[d(l(U),{component:l(pt)},null,8,["component"])]),default:f(()=>[g[4]||(g[4]=x(" 选择或拖入文件 ",-1))]),_:1},8,["onClick"])]),_:1}),d(l(V),{type:"info",ghost:"",onClick:y},{icon:f(()=>[d(l(U),{component:l(vt)},null,8,["component"])]),default:f(()=>[g[5]||(g[5]=x(" 加载样例 ",-1))]),_:1})]),_:1}),d(l(mt),{id:l(e),onClick:S},null,8,["id"])]),_:1},8,["file-list"])]),suffix:f(()=>[d(l(V),{disabled:typeof t.value!="number",type:i.value?"error":"success",ghost:"",onClick:g[1]||(g[1]=C=>i.value=!i.value)},{icon:f(()=>[d(l(U),{component:i.value?l(Bt):l(yt)},null,8,["component"])]),default:f(()=>[x(" "+D(i.value?"暂停":"播放"),1)]),_:1},8,["disabled","type"])]),_:1},8,["options","volume"])]),right:f(()=>[s.value?(M(),I("div",Rt,[d(l(st),null,{default:f(()=>[d(l(E),null,{default:f(()=>[x(D(s.value.name),1)]),_:1}),d(l(T),{type:"info"},{default:f(()=>[x(D(s.value.type),1)]),_:1}),d(l(T),{color:{color:"#8a2be21a",textColor:"#9339E7FF",borderColor:"#9339E7FF"}},{default:f(()=>[x(D(s.value.size),1)]),_:1}),d(l(T),{type:"success"},{default:f(()=>[x(D(s.value.totalDuration),1)]),_:1}),d(l(T),{type:"warning"},{default:f(()=>[x(D(s.value.sampleRate)+"Hz ",1)]),_:1}),d(l(T),null,{default:f(()=>[x(D(s.value.channelCount)+"ch ",1)]),_:1}),d(l(T),null,{default:f(()=>[x(D(s.value.bitDepth)+"bit ",1)]),_:1})]),_:1}),F("canvas",{id:l(a)},null,8,Vt),F("div",Ut,[d(l(E),null,{default:f(()=>[x(D(s.value.currentTime),1)]),_:1}),d(l(E),null,{default:f(()=>[x(D(s.value.totalDuration),1)]),_:1})])])):it("",!0)]),_:1})]),_:1}))}}),le=q($t,[["__scopeId","data-v-e4e5bbdb"]]);export{le as default};
